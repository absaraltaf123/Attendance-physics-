<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Admin</title>
    <!-- Font Awesome & Chart.js (Optional) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* --- Styles remain largely the same, adding style for subject select --- */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50c878;
            --background-color: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --red-color: #ff6b6b;
            --yellow-color: #ffd166;
            --green-color: #06d6a0;
            --admin-accent: #e67e22; /* Orange accent for admin */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #eef2f3 0%, #8e9eab 100%); min-height: 100vh; padding: 20px; overflow: hidden; }
        .container { display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(8px); border-radius: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); border: 1px solid var(--border-color); overflow: hidden; height: calc(100vh - 40px); }
        .topbar { display: flex; justify-content: space-around; align-items: center; padding: 10px 0; background: rgba(255, 255, 255, 0.3); border-bottom: 1px solid var(--border-color); position: relative; flex-shrink: 0; }
        .nav-item { padding: 10px 20px; cursor: pointer; transition: all 0.3s ease; color: var(--text-color); font-size: 22px; text-align: center; }
        .nav-item.active { color: var(--admin-accent); }
        .nav-item:hover:not(.active) { color: var(--admin-accent); opacity: 0.8; }
        .highlight { position: absolute; bottom: 0; height: 3px; background: var(--admin-accent); box-shadow: 0 0 8px var(--admin-accent); transition: all 0.3s ease; border-radius: 1.5px; }
        .content { flex: 1; overflow-y: auto; padding: 25px; position: relative; }
        .page { display: none; position: absolute; width: calc(100% - 50px); top: 25px; left: 25px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; position: relative; width: 100%; top: 0; left: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: var(--admin-accent); margin-bottom: 25px; font-weight: 600; border-bottom: 2px solid var(--admin-accent); padding-bottom: 12px; font-size: 1.8em; }

        .controls-container { /* NEW: Wrapper for subject and date */
            display: flex;
            flex-direction: column; /* Stack vertically */
            gap: 15px; /* Space between rows */
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .control-row { /* NEW: Row for subject or date */
             display: flex;
             align-items: center;
             gap: 15px;
             flex-wrap: wrap;
        }
        .control-row label {
            font-weight: 500;
            color: var(--text-color);
            flex-shrink: 0; /* Prevent label shrinking */
            min-width: 60px; /* Ensure label has some width */
        }
        .subject-select, .date-input { /* Shared styles */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            flex-grow: 1; /* Allow input/select to take space */
            min-width: 180px;
        }
         .subject-select.error-input, .date-input.error-input {
            border-color: var(--red-color);
         }

        .button-group { /* NEW: Group for action buttons */
             display: flex;
             gap: 10px;
             flex-wrap: wrap; /* Allow buttons to wrap */
             justify-content: flex-end; /* Align buttons to the right */
             width: 100%; /* Take full width within the row */
        }
        @media (min-width: 769px) { /* On larger screens, put buttons beside date */
             .controls-container { gap: 20px; }
             .control-row.date-buttons { justify-content: space-between; } /* Space out date input and buttons */
             .button-group { width: auto; justify-content: flex-start; }
        }

        .btn { padding: 10px 20px; border-radius: 8px; border: none; background: var(--primary-color); color: white; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .btn:hover { background: #357abd; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .btn:active { transform: translateY(0px); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .btn-save { background: var(--secondary-color); }
        .btn-save:hover { background: #42a866; }
        .btn-delete { background: var(--red-color); }
        .btn-delete:hover { background: #d63031; }
        .btn-generate { background: var(--admin-accent); }
        .btn-generate:hover { background: #c66a11; }
        .btn-share { background: var(--primary-color); margin-left: 10px; }
        .btn-share:hover { background: #357abd; }

        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: rgba(255, 255, 255, 0.85); border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px var(--shadow-color); border: 1px solid var(--border-color); }
        thead { background: rgba(230, 126, 34, 0.15); }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { font-weight: 600; color: var(--admin-accent); font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: rgba(230, 126, 34, 0.08); }
        select.attendance-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background: white; width: 100%; min-width: 110px; font-size: 14px; cursor: pointer; transition: border-color 0.2s ease; }
        select.attendance-select:focus { border-color: var(--admin-accent); outline: none; }
        select.attendance-select.error-input { border-color: var(--red-color); }

        .status-present { color: var(--green-color); font-weight: 500; }
        .status-absent { color: var(--red-color); font-weight: 500; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .loading.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .spinner { border: 5px solid rgba(74, 144, 226, 0.2); border-radius: 50%; border-top-color: var(--admin-accent); width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { color: var(--red-color); margin-top: 15px; padding: 12px 18px; background-color: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; font-weight: 500; display: none; transition: opacity 0.3s ease; }
        .error-message.active { display: block; }
        .toast { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: var(--secondary-color); color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); opacity: 0; transform: translateX(-50%) translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 10001; font-weight: 500; min-width: 250px; text-align: center; visibility: hidden; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); visibility: visible; }
        .toast.hide { opacity: 0; transform: translateX(-50%) translateY(20px); visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.3s; }
        .toast.error { background: var(--red-color); }
        .toast.info { background: var(--primary-color); }

        /* Admin Specific: Manage Students Section (styles unchanged) */
        .manage-students-card { background: rgba(255, 255, 255, 0.8); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 15px var(--shadow-color); border: 1px solid var(--border-color); }
        .manage-students-card h2 { color: var(--admin-accent); margin-bottom: 18px; font-size: 1.3em; font-weight: 600; }
        .add-student-form { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px dashed var(--border-color); }
        .add-student-form input { padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.9); font-size: 15px; flex-grow: 1; }
        .add-student-form input[type="text"] { min-width: 150px; }
        .add-student-form button { align-self: center; }

        /* Date history chips styling (styles unchanged) */
         .date-history { margin-top: 25px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; }
         .date-chip { background: rgba(255, 255, 255, 0.3); border-radius: 15px; padding: 6px 18px; font-size: 14px; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.3s ease; color: #555; }
         .date-chip:hover { background: rgba(230, 126, 34, 0.15); border-color: rgba(230, 126, 34, 0.4); color: var(--admin-accent); }
         .date-chip.active { background: var(--admin-accent); color: white; border-color: var(--admin-accent); font-weight: 500; }

        /* Present List Display Section (styles unchanged) */
        .present-list-display { margin-top: 30px; padding: 25px; background: rgba(255, 255, 255, 0.85); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 5px 15px var(--shadow-color); display: none; animation: fadeIn 0.4s ease-out; }
        .present-list-display h3 { color: var(--admin-accent); margin-bottom: 18px; font-size: 1.4em; font-weight: 600; border-bottom: 1px solid rgba(230, 126, 34, 0.3); padding-bottom: 10px; }
        .formatted-present-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; }
        .formatted-present-list p { margin-bottom: 8px; font-size: 15px; line-height: 1.5; }
        .formatted-present-list strong { display: inline-block; min-width: 80px; color: var(--primary-color); }
        .present-list-actions { text-align: right; }

        /* Responsive adjustments (PASTED, Minor tweaks for new controls) */
        @media (max-width: 768px) {
             body { padding: 10px; overflow: auto; }
             .container { height: auto; min-height: calc(100vh - 20px); overflow: visible; flex-direction: column; }
             .content { overflow-y: visible; padding: 15px; }
             .page { position: relative; width: 100%; top: 0; left: 0; padding: 0; animation: none; display: none; }
             .page.active { display: block; position: relative; width: 100%; top: 0; left: 0; }
             /* Controls container already stacked, looks okay */
             .control-row { flex-direction: column; align-items: stretch; } /* Stack label and input */
             .control-row label { margin-bottom: 5px; min-width: unset; }
             .subject-select, .date-input { width: 100%; }
             .button-group { justify-content: space-around; } /* Space out buttons */

             /* Mobile Table Styles (Unchanged) */
             table, thead, tbody, th, td, tr { display: block; }
             thead tr { position: absolute; top: -9999px; left: -9999px; }
             tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; background: rgba(255,255,255,0.85); padding: 10px; }
             td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 45%; text-align: right; min-height: 38px; display: flex; align-items: center; justify-content: flex-end; }
             td:before { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--admin-accent); font-size: 0.9em; }
             td:last-child { border-bottom: 0; }
             #attendance-table td:nth-of-type(1):before { content: "Roll No"; }
             #attendance-table td:nth-of-type(2):before { content: "Name"; }
             #attendance-table td:nth-of-type(3):before { content: "Status"; }
             #students-table td:nth-of-type(1):before { content: "Roll No"; }
             #students-table td:nth-of-type(2):before { content: "Name"; }
             #students-table td:nth-of-type(3):before { content: "Course"; }
             #students-table td:nth-of-type(4):before { content: "Action"; }
             td select.attendance-select { width: auto; min-width: 120px; }
             td .btn-delete-small { padding: 5px 10px; font-size: 12px; }

             .nav-item { padding: 8px 15px; font-size: 20px; }
             .highlight { height: 2px; }
             .toast { width: calc(100% - 30px); bottom: 15px; left: 15px; transform: translateX(0) translateY(20px); }
             .toast.show { transform: translateX(0) translateY(0); }
             .toast.hide { transform: translateX(0) translateY(20px); }
             .add-student-form { flex-direction: column; }
             .add-student-form input { width: 100%; }
             .add-student-form button { width: 100%; }
             .present-list-display { padding: 15px; }
             .present-list-display h3 { font-size: 1.2em; }
             .formatted-present-list { max-height: 250px; }
             .present-list-actions { text-align: center; }
             .btn-share { margin-left: 0; margin-top: 10px; width: 100%; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="nav-item active" data-page="attendance" title="Mark Attendance"><i class="fas fa-calendar-check"></i></div>
            <div class="nav-item" data-page="students" title="Manage Students"><i class="fas fa-users-cog"></i></div>
            <div class="highlight"></div>
        </div>

        <div class="content">
            <!-- Attendance Marking Page -->
            <div id="attendance-page" class="page active">
                <h1>Mark Daily Attendance</h1>

                <!-- MODIFIED: Controls wrapped -->
                <div class="controls-container">
                    <div class="control-row">
                        <label for="subject-select">Subject:</label>
                        <select id="subject-select" class="subject-select">
                            <option value="">-- Select Subject --</option>
                            <!-- Options populated by JS -->
                            <option value="Quantum Mechanics">Quantum Mechanics</option>
                            <option value="Statistical Physics">Statistical Physics</option>
                            <option value="Electrodynamics">Electrodynamics</option>
                        </select>
                    </div>
                    <div class="control-row date-buttons"> <!-- Added class for potential styling -->
                        <label for="attendance-date">Date:</label>
                        <input type="date" id="attendance-date" class="date-input">
                        <div class="button-group">
                            <button id="load-btn" class="btn">Load Data</button>
                            <button id="save-btn" class="btn btn-save">Save Attendance</button>
                            <button id="generate-present-list-btn" class="btn btn-generate">Generate Present List</button>
                        </div>
                    </div>
                </div>

                 <!-- Error message placeholder -->
                <div id="attendance-error" class="error-message"></div>
                <!-- History of recorded dates -->
                <div class="date-history" id="date-history"></div>
                <!-- Attendance Table (Editable) -->
                <table id="attendance-table">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-tbody"></tbody>
                </table>

                <!-- Container for Present List Display -->
                <div id="present-list-display" class="present-list-display">
                    <h3 id="present-list-title">Present Students</h3>
                    <div id="formatted-present-list" class="formatted-present-list"></div>
                    <div class="present-list-actions">
                        <button id="share-present-list-btn" class="btn btn-share"><i class="fas fa-share-alt"></i> Share List</button>
                    </div>
                </div>
            </div>

            <!-- Manage Students Page -->
            <div id="students-page" class="page">
                 <h1>Manage Students</h1>
                 <div class="manage-students-card">
                     <h2>Add New Student</h2>
                     <div id="add-student-error" class="error-message"></div>
                     <form id="add-student-form" class="add-student-form">
                         <input type="text" id="new-roll-no" placeholder="Roll Number (e.g., 220XXX)" required>
                         <input type="text" id="new-student-name" placeholder="Full Name" required>
                         <input type="text" id="new-student-course" placeholder="Course (Optional)">
                         <button type="submit" class="btn btn-save">Add Student</button>
                     </form>
                 </div>
                  <div class="manage-students-card">
                     <h2>Current Student List</h2>
                     <table id="students-table">
                         <thead>
                             <tr>
                                 <th>Roll No</th>
                                 <th>Name</th>
                                 <th>Course</th>
                                 <th>Action</th>
                             </tr>
                         </thead>
                         <tbody id="students-tbody"></tbody>
                     </table>
                 </div>
             </div>

        </div> <!-- End Content -->
    </div> <!-- End Container -->

     <!-- Loading Spinner -->
    <div class="loading" id="loading-spinner">
        <div class="spinner"></div>
    </div>

    <!-- Toast Message -->
    <div class="toast" id="toast-message"></div>

    <!-- JavaScript Implementation -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Configuration ---
            const API_BASE_URL = '';
            const DEFAULT_STATUS = "absent";
            const TOAST_DURATION = 3000;
            // Define subjects available for marking
            const AVAILABLE_SUBJECTS = ["Quantum Mechanics", "Statistical Physics", "Electrodynamics"];

            // --- Global State ---
            let STUDENTS = [];
            let attendanceDataCache = {}; // Cache: { subject: { date: [...] } }
            let currentPage = "attendance";
            const pageIds = {"attendance": "attendance-page", "students": "students-page"};
            let toastTimerId = null;
            let recordedDates = new Set(); // Tracks dates with *any* record across *any* subject

            // --- DOM Element References ---
            const loadingSpinner = document.getElementById('loading-spinner');
            const toastMessageElement = document.getElementById('toast-message');
            // Attendance Page
            const attendanceTbody = document.getElementById('attendance-tbody');
            const subjectSelect = document.getElementById('subject-select'); // *** NEW ***
            const attendanceDateInput = document.getElementById('attendance-date');
            const attendanceErrorElement = document.getElementById('attendance-error');
            const dateHistoryElement = document.getElementById('date-history');
            const loadBtn = document.getElementById('load-btn');
            const saveBtn = document.getElementById('save-btn');
            const generatePresentListBtn = document.getElementById('generate-present-list-btn');
            const presentListDisplay = document.getElementById('present-list-display');
            const presentListTitle = document.getElementById('present-list-title');
            const formattedPresentList = document.getElementById('formatted-present-list');
            const sharePresentListBtn = document.getElementById('share-present-list-btn');
            // Students Page
            const studentsTbody = document.getElementById('students-tbody');
            const addStudentForm = document.getElementById('add-student-form');
            const newRollNoInput = document.getElementById('new-roll-no');
            const newStudentNameInput = document.getElementById('new-student-name');
            const newStudentCourseInput = document.getElementById('new-student-course');
            const addStudentErrorElement = document.getElementById('add-student-error');
            // Common
            const contentElement = document.querySelector('.content');
            const navItems = document.querySelectorAll('.nav-item');
            const highlightElement = document.querySelector('.highlight');

            // --- Utility Functions (Unchanged) ---
            function getTodayDate() { return new Date().toISOString().split('T')[0]; }
            function showLoading(show = true) { loadingSpinner.classList.toggle("active", show); }
            function showToast(message, type = "success", duration = TOAST_DURATION) { /* ... same ... */
                 toastMessageElement.textContent = message;
                 toastMessageElement.className = `toast ${type}`;
                 if (toastTimerId) clearTimeout(toastTimerId);
                 requestAnimationFrame(() => {
                    toastMessageElement.classList.add("show");
                    toastMessageElement.classList.remove("hide");
                 });
                 toastTimerId = setTimeout(() => hideToast(toastMessageElement), duration);
            }
            function hideToast(toastElement) { /* ... same ... */
                toastElement.classList.add("hide");
                toastElement.classList.remove("show");
                toastTimerId = null;
            }
            function showError(elementId, message = "", show = true) { /* ... same ... */
                const errorElement = document.getElementById(elementId);
                if (!errorElement) return;
                errorElement.textContent = message;
                errorElement.classList.toggle("active", show && message);
                 // Highlight related input fields
                if (show && message) {
                     if (message.toLowerCase().includes("subject")) {
                         subjectSelect.classList.add('error-input');
                     } else {
                          subjectSelect.classList.remove('error-input');
                     }
                     if (message.toLowerCase().includes("date")) {
                          attendanceDateInput.classList.add('error-input');
                     } else {
                          attendanceDateInput.classList.remove('error-input');
                     }
                      if (message.toLowerCase().includes("select a status")) {
                         // Error highlighting for individual selects is handled in saveAttendance
                     }
                 } else {
                      subjectSelect.classList.remove('error-input');
                      attendanceDateInput.classList.remove('error-input');
                 }
            }
            function consoleLog(message) { console.log(`Admin App: ${message}`); }

            // --- API Interaction (MODIFIED: URL encoding) ---
            async function apiRequest(url, options = {}) {
                showLoading(true);
                try {
                    // Encode URL components properly
                    const encodedUrl = `${API_BASE_URL}${url}`;
                    const response = await fetch(encodedUrl, options);
                    const responseData = await response.json();

                    if (!response.ok) {
                        const errorMsg = responseData.message || `HTTP error! status: ${response.status}`;
                        throw new Error(errorMsg);
                    }
                    return responseData;
                } catch (error) {
                    console.error(`API Request Failed: ${options.method || 'GET'} ${url}`, error);
                    showToast(error.message || "Network error or server unavailable", "error", 5000);
                    throw error;
                } finally {
                    showLoading(false);
                }
            }

             // --- Student Management (Unchanged) ---
            async function fetchStudents() { /* ... same ... */
                try {
                    STUDENTS = await apiRequest('/api/students');
                    consoleLog(`Fetched ${STUDENTS.length} students.`);
                    renderStudentList();
                    if (currentPage === 'attendance') {
                        initAttendanceTable();
                        loadAttendanceForDateAndSubject(); // Reload with current subject/date
                        presentListDisplay.style.display = 'none';
                    }
                } catch (error) {
                    STUDENTS = [];
                    renderStudentList();
                    initAttendanceTable();
                }
            }
            function renderStudentList() { /* ... same ... */
                studentsTbody.innerHTML = "";
                 if (!STUDENTS || STUDENTS.length === 0) {
                    studentsTbody.innerHTML = '<tr><td colspan="4">No students found. Add students using the form above.</td></tr>';
                    return;
                }
                STUDENTS.forEach(student => { /* ... same row creation ... */
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="Roll No">${student.roll_no}</td>
                        <td data-label="Name">${student.name}</td>
                        <td data-label="Course">${student.course || 'N/A'}</td>
                        <td data-label="Action">
                            <button class="btn btn-delete btn-delete-small" data-roll="${student.roll_no}">Delete</button>
                        </td>
                    `;
                    row.querySelector('.btn-delete').addEventListener('click', handleDeleteStudent);
                    studentsTbody.appendChild(row);
                });
            }
            async function handleAddStudent(event) { /* ... same ... */
                event.preventDefault();
                showError("add-student-error", "", false);
                const rollNo = newRollNoInput.value.trim();
                const name = newStudentNameInput.value.trim();
                const course = newStudentCourseInput.value.trim();
                if (!rollNo || !name) {
                    showError("add-student-error", "Roll Number and Name cannot be empty.", true);
                    return;
                }
                try {
                    const newStudent = await apiRequest('/api/students', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roll_no: rollNo, name: name, course: course })
                    });
                    showToast(`Student ${newStudent.name} added successfully!`, "success");
                    addStudentForm.reset();
                    await fetchStudents();
                } catch (error) {
                     showError("add-student-error", error.message || "Failed to add student.", true);
                }
            }
            async function handleDeleteStudent(event) { /* ... same ... */
                 const rollNo = event.target.dataset.roll;
                 const student = STUDENTS.find(s => s.roll_no === rollNo);
                 const studentName = student ? student.name : rollNo;
                 if (!rollNo) return;
                 if (!confirm(`Are you sure you want to delete student ${studentName} (${rollNo})? This will also remove their past attendance records for ALL subjects.`)) {
                     return;
                 }
                 try {
                     await apiRequest(`/api/students/${rollNo}`, { method: 'DELETE' });
                     showToast(`Student ${studentName} deleted successfully.`, "success");
                     await fetchStudents(); // Refresh list and attendance table
                     await fetchRecordedDates(); // Refresh date history
                 } catch (error) { /* Error toast shown by apiRequest */ }
            }

            // --- Attendance Management (MODIFIED) ---
             function initAttendanceTable() { /* ... same logic ... */
                 attendanceTbody.innerHTML = "";
                 if (!STUDENTS || STUDENTS.length === 0) {
                     attendanceTbody.innerHTML = '<tr><td colspan="3">No student data. Add students in the "Manage Students" tab first.</td></tr>';
                     return;
                 }
                 STUDENTS.forEach(student => {
                     const row = document.createElement('tr');
                     row.innerHTML = `
                         <td data-label="Roll No">${student.roll_no}</td>
                         <td data-label="Name">${student.name}</td>
                         <td data-label="Status">
                             <select class="attendance-select" data-roll="${student.roll_no}">
                                 <option value="">Select</option>
                                 <option value="present">Present</option>
                                 <option value="absent">Absent</option>
                             </select>
                         </td>
                     `;
                     attendanceTbody.appendChild(row);
                 });
                 consoleLog("Admin: Attendance table structure initialized.");
                 presentListDisplay.style.display = 'none';
            }

            async function fetchRecordedDates() { // MODIFIED: Iterate through subjects
                 try {
                     // Fetch all attendance data (nested structure)
                     const allAttendance = await apiRequest('/api/attendance'); // Returns { subject: { date: [...] } }
                     recordedDates = new Set(); // Reset
                     // Iterate through each subject, then each date within the subject
                     Object.values(allAttendance).forEach(subjectData => {
                         Object.keys(subjectData).forEach(date => {
                             recordedDates.add(date); // Add unique dates
                         });
                     });
                     updateDateHistory();
                 } catch (error) {
                     consoleLog("Failed to fetch recorded dates for history.");
                     updateDateHistory(); // Render with potentially empty set
                 }
            }

            function updateDateHistory() { /* ... same logic ... */
                dateHistoryElement.innerHTML = "";
                const dates = Array.from(recordedDates).sort().reverse();
                dates.forEach(date => {
                    const chip = document.createElement('div');
                    chip.className = 'date-chip';
                    chip.textContent = date;
                    chip.dataset.date = date;
                    chip.addEventListener('click', () => {
                         attendanceDateInput.value = date;
                         loadAttendanceForDateAndSubject(); // Trigger load with current subject
                         presentListDisplay.style.display = 'none';
                    });
                    dateHistoryElement.appendChild(chip);
                });
                highlightActiveDateChip();
            }
             function highlightActiveDateChip() { /* ... same logic ... */
                 const currentDate = attendanceDateInput.value;
                 document.querySelectorAll(".date-chip").forEach(chip => {
                     chip.classList.toggle("active", chip.dataset.date === currentDate);
                 });
            }

            // *** NEW *** Combined load function
            async function loadAttendanceForDateAndSubject() {
                const date = attendanceDateInput.value;
                const subject = subjectSelect.value;

                consoleLog(`Admin: Loading attendance for Subject: ${subject}, Date: ${date}`);
                showError("attendance-error", "", false);
                attendanceTbody.querySelectorAll('.attendance-select').forEach(s => {
                     s.value = ""; // Reset selects
                     s.classList.remove('error-input');
                });
                presentListDisplay.style.display = 'none';
                highlightActiveDateChip();

                // *** NEW *** Validate subject and date
                if (!subject) {
                     showToast("Please select a subject.", "info");
                     showError("attendance-error", "Please select a subject.", true);
                     return;
                }
                if (!date) {
                    showToast("Please select a date.", "info");
                    showError("attendance-error", "Please select a date.", true);
                    return;
                }
                if (!STUDENTS || STUDENTS.length === 0) {
                    showError("attendance-error", "Cannot load attendance, student list is empty.", true);
                    return;
                }

                 // *** MODIFIED *** Check cache (nested structure)
                 if (attendanceDataCache[subject]?.[date]) {
                    consoleLog("Loading attendance from cache.");
                    populateAttendanceTable(attendanceDataCache[subject][date]);
                    showToast(`Attendance loaded for ${subject} on ${date} (from cache).`, "info", 1500);
                    return;
                 }

                 // If not in cache, fetch from server (use new endpoint)
                 try {
                    // *** MODIFIED *** Use new API endpoint with encoded subject
                    const encodedSubject = encodeURIComponent(subject);
                    const dateData = await apiRequest(`/api/attendance/${encodedSubject}/${date}`);

                    // *** MODIFIED *** Store in nested cache
                    attendanceDataCache[subject] = attendanceDataCache[subject] || {};
                    attendanceDataCache[subject][date] = dateData;

                    populateAttendanceTable(dateData);
                     if (dateData.length > 0) {
                         showToast(`Attendance loaded for ${subject} on ${date} from server.`, "info");
                     } else {
                         showToast(`No saved record for ${subject} on ${date}. Set defaults.`, "info");
                         // Set default status if no record exists
                          attendanceTbody.querySelectorAll('.attendance-select').forEach(select => {
                             select.value = DEFAULT_STATUS;
                          });
                     }
                 } catch (error) {
                     showError("attendance-error", `Failed to load attendance for ${subject} on ${date}: ${error.message}`, true);
                     attendanceTbody.querySelectorAll('.attendance-select').forEach(s => s.value = "");
                 }
            }

             function populateAttendanceTable(dateData) { /* ... same logic ... */
                 const attendanceMap = new Map(dateData.map(item => [item.roll_no, item.status]));
                 attendanceTbody.querySelectorAll('.attendance-select').forEach(select => {
                     const rollNo = select.dataset.roll;
                     const status = attendanceMap.get(rollNo);
                     if (status) {
                         select.value = status;
                     } else {
                         select.value = DEFAULT_STATUS;
                         consoleLog(`Student ${rollNo} not found in saved data for this subject/date, setting default.`);
                     }
                 });
             }

            async function saveAttendance() { // MODIFIED: Include subject
                 const date = attendanceDateInput.value;
                 const subject = subjectSelect.value; // *** NEW ***

                 // *** NEW *** Validate subject and date
                 if (!subject) {
                     showError("attendance-error", "Please select a subject before saving!", true);
                     showToast("Select a subject!", "error");
                     return;
                 }
                  if (!date) {
                     showError("attendance-error", "Please select a date before saving!", true);
                     showToast("Select a date!", "error");
                     return;
                  }

                 let attendanceList = [];
                 let allSelected = true;

                 showError("attendance-error", "", false); // Clear previous errors
                 const selects = attendanceTbody.querySelectorAll('.attendance-select');
                 selects.forEach(s => s.classList.remove('error-input'));
                 presentListDisplay.style.display = 'none';

                 if (selects.length === 0 && STUDENTS.length > 0) {
                     showError("attendance-error", "Attendance table not populated correctly.", true);
                     return;
                 }
                 if (selects.length === 0 && STUDENTS.length === 0) {
                      showError("attendance-error", "No students to mark attendance for.", true);
                      return;
                 }

                 selects.forEach(select => {
                     const rollNo = select.dataset.roll;
                     const status = select.value;
                     if (!status) {
                         allSelected = false;
                         select.classList.add('error-input');
                     }
                     if (STUDENTS.some(s => s.roll_no === rollNo)) {
                         attendanceList.push({ roll_no: rollNo, status: status });
                     }
                 });

                 if (!allSelected) {
                    showError("attendance-error", "Please select a status (Present/Absent) for all students.", true);
                    showToast("Incomplete attendance!", "error");
                    return;
                 }

                 consoleLog(`Attempting to save attendance for Subject: ${subject}, Date: ${date}`);
                 try {
                    // *** MODIFIED *** Use new API endpoint with encoded subject
                    const encodedSubject = encodeURIComponent(subject);
                    const result = await apiRequest(`/api/attendance/${encodedSubject}/${date}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(attendanceList)
                    });
                    showToast(result.message || `Attendance for ${subject} on ${date} saved successfully!`, "success");

                    // *** MODIFIED *** Update nested cache
                    attendanceDataCache[subject] = attendanceDataCache[subject] || {};
                    attendanceDataCache[subject][date] = attendanceList.map(att => { // Enrich with names for consistency if needed
                        const student = STUDENTS.find(s => s.roll_no === att.roll_no);
                        return {...att, name: student?.name };
                    });

                    recordedDates.add(date); // Add date to history set (tracks ANY record)
                    updateDateHistory(); // Refresh chips
                 } catch (error) {
                    showError("attendance-error", `Failed to save: ${error.message}`, true);
                 }
            }

            // MODIFIED: Generate list for current subject/date
            async function generatePresentListDisplay() {
                 const date = attendanceDateInput.value;
                 const subject = subjectSelect.value; // *** NEW ***

                 // *** NEW *** Validate subject and date
                 if (!subject) {
                     showToast("Please select a subject first.", "error");
                     showError("attendance-error", "Select a subject to generate the list.", true);
                     presentListDisplay.style.display = 'none';
                     return;
                 }
                 if (!date) {
                     showToast("Please select a date first.", "error");
                     showError("attendance-error", "Select a date to generate the list.", true);
                     presentListDisplay.style.display = 'none';
                     return;
                 }
                 showError("attendance-error", "", false); // Clear error

                 // *** MODIFIED *** Get attendance data from cache or fetch for specific subject/date
                 let dateData = attendanceDataCache[subject]?.[date];
                 if (!dateData) {
                     consoleLog("Present list: Data not in cache, fetching...");
                     try {
                         const encodedSubject = encodeURIComponent(subject);
                         dateData = await apiRequest(`/api/attendance/${encodedSubject}/${date}`);
                         // Update cache
                         attendanceDataCache[subject] = attendanceDataCache[subject] || {};
                         attendanceDataCache[subject][date] = dateData;
                     } catch (error) {
                         showError("attendance-error", `Failed to load data for list generation: ${error.message}`, true);
                         presentListDisplay.style.display = 'none';
                         return;
                     }
                 }

                 if (!dateData) dateData = [];

                 // Filter and sort (logic unchanged)
                 const presentStudents = dateData
                    .filter(item => item.status === 'present')
                    .map(item => {
                        const studentInfo = STUDENTS.find(s => s.roll_no === item.roll_no);
                        return { roll_no: item.roll_no, name: studentInfo ? studentInfo.name : 'Unknown' };
                    })
                    .sort((a, b) => a.roll_no.localeCompare(b.roll_no));

                // *** MODIFIED *** Update the display title with subject
                presentListTitle.textContent = `Present Students - ${subject} - ${date}`;
                if (presentStudents.length > 0) {
                    let listHtml = '';
                    presentStudents.forEach(student => {
                        listHtml += `<p><strong>${student.roll_no}</strong> ${student.name}</p>`;
                    });
                    formattedPresentList.innerHTML = listHtml;
                } else {
                    formattedPresentList.innerHTML = `<p>No students were marked present for ${subject} on ${date}.</p>`;
                }

                presentListDisplay.style.display = 'block';
                presentListDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // MODIFIED: Include subject in shared text
            async function sharePresentList() {
                const date = attendanceDateInput.value;
                const subject = subjectSelect.value; // *** NEW ***

                // *** NEW *** Validate subject
                 if (!subject || !date) {
                     showToast("Cannot share - Select subject and date first.", "error");
                     return;
                 }

                const title = `Present List - ${subject} - ${date}`; // Updated title
                let shareText = `${title}\n\n`;

                const presentStudents = Array.from(formattedPresentList.querySelectorAll('p')).map(p => {
                    const roll = p.querySelector('strong')?.textContent || '';
                    const name = p.textContent.replace(roll, '').trim();
                    return `${roll}: ${name}`;
                });

                if (presentStudents.length === 0 || (presentStudents.length === 1 && presentStudents[0].includes("No students"))) {
                    showToast("No present students to share.", "info");
                    return;
                }

                shareText += presentStudents.join('\n');

                // Sharing logic (unchanged)
                if (navigator.share) { /* ... */
                     try {
                        await navigator.share({ title: title, text: shareText });
                        consoleLog('Present list shared successfully via Web Share API.');
                        showToast('List shared!', 'success');
                    } catch (error) {
                        console.error('Error sharing via Web Share API:', error);
                        if (error.name !== 'AbortError') {
                             showToast('Could not share list automatically.', 'error');
                        }
                    }
                } else if (navigator.clipboard) { /* ... */
                     try {
                        await navigator.clipboard.writeText(shareText);
                        showToast('List copied to clipboard!', 'success');
                    } catch (error) {
                         console.error('Error copying to clipboard:', error);
                         showToast('Could not copy list to clipboard.', 'error');
                    }
                } else { /* ... */
                    showToast('Sharing not supported. Try copying the list manually.', 'info');
                }
            }

            // --- Navigation (Unchanged logic, but page loads consider subject) ---
            function switchPage(targetPageId) { /* ... same logic ... */
                if (!pageIds[targetPageId]) return;
                 if (targetPageId === currentPage) return;
                 consoleLog(`Admin: Switching page to ${targetPageId}`);
                 Object.values(pageIds).forEach(pageDomId => {
                    document.getElementById(pageDomId)?.classList.toggle("active", pageDomId === pageIds[targetPageId]);
                 });
                 navItems.forEach(item => {
                    item.classList.toggle("active", item.dataset.page === targetPageId);
                 });
                 currentPage = targetPageId;
                 updateHighlight();
                 presentListDisplay.style.display = 'none';

                 if (targetPageId === "students") {
                    fetchStudents();
                 } else if (targetPageId === "attendance") {
                     initAttendanceTable(); // Rebuild structure
                     loadAttendanceForDateAndSubject(); // Load data for current selection
                     fetchRecordedDates(); // Refresh history
                 }
            }
            function onNavClick(event) { /* ... same ... */
                 const targetPage = event.currentTarget.dataset.page;
                 if (targetPage) switchPage(targetPage);
            }
            function updateHighlight() { /* ... same ... */
                const activeNav = document.querySelector(".nav-item.active");
                if (activeNav && highlightElement) {
                    highlightElement.style.left = `${activeNav.offsetLeft}px`;
                    highlightElement.style.width = `${activeNav.offsetWidth}px`;
                } else if (highlightElement) {
                     highlightElement.style.width = `0px`;
                }
            }

             // *** NEW *** Populate subject dropdown
             function populateSubjectDropdown() {
                 subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>'; // Clear existing
                 AVAILABLE_SUBJECTS.forEach(subj => {
                     const option = document.createElement('option');
                     option.value = subj;
                     option.textContent = subj;
                     subjectSelect.appendChild(option);
                 });
             }

            // --- Initialization ---
            function initEventListeners() {
                navItems.forEach(item => item.addEventListener('click', onNavClick));
                // Attendance
                loadBtn.addEventListener('click', loadAttendanceForDateAndSubject); // Use combined loader
                saveBtn.addEventListener('click', saveAttendance);
                generatePresentListBtn.addEventListener('click', generatePresentListDisplay);
                // *** NEW *** Trigger load on subject or date change
                subjectSelect.addEventListener('change', () => {
                    loadAttendanceForDateAndSubject();
                    presentListDisplay.style.display = 'none';
                });
                attendanceDateInput.addEventListener('change', () => {
                    loadAttendanceForDateAndSubject();
                    presentListDisplay.style.display = 'none';
                });
                sharePresentListBtn.addEventListener('click', sharePresentList);
                // Students
                addStudentForm.addEventListener('submit', handleAddStudent);
                // Common
                window.addEventListener('resize', updateHighlight);
                consoleLog("Admin: Event listeners initialized.");
            }

             async function initAdminApp() {
                consoleLog("Initializing Admin Attendance System...");
                showLoading(true);
                populateSubjectDropdown(); // *** NEW ***
                initEventListeners();

                try {
                    await fetchStudents(); // Fetches students, renders list, inits attendance table
                    await fetchRecordedDates(); // Fetches dates with any record

                    // Set default date for attendance page
                    const today = getTodayDate();
                    attendanceDateInput.value = today;
                    consoleLog(`Admin: Set date to today: ${today}`);

                    // Don't auto-load data here, wait for subject selection
                    // await loadAttendanceForDateAndSubject(); // Remove initial load

                    setTimeout(updateHighlight, 150); // Set initial highlight
                    showToast("Admin system ready. Select subject and date.", "info", 2500); // Info prompt

                } catch (e) {
                     console.error(`Critical Error during admin app initialization: ${e}`);
                     showToast("Error initializing admin application!", "error", 5000);
                     if (contentElement) {
                         contentElement.innerHTML = `<h1>Initialization Error</h1><p>Could not start the admin application. API might be down or data file corrupted.</p><p>Error: ${e.message}</p>`;
                     }
                 } finally {
                    showLoading(false);
                 }
            }

            // --- Start the application ---
            initAdminApp();

        }); // End DOMContentLoaded
    </script>
</body>
</html>
