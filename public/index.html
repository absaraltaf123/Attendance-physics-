<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance View</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Embedded CSS Start */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50c878;
            --background-color: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --red-color: #ff6b6b;
            --yellow-color: #ffd166;
            --green-color: #06d6a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow: hidden; /* Prevent body scrollbars when container fits viewport */
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid var(--border-color);
            overflow: hidden;
            height: calc(100vh - 40px); /* Fill viewport height minus body padding */
        }

        .topbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid var(--border-color);
            position: relative; /* For highlight positioning */
            flex-shrink: 0; /* Prevent topbar from shrinking */
        }

        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-size: 24px; /* Icon size */
            text-align: center;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item:hover:not(.active) {
             color: var(--primary-color);
             opacity: 0.8;
        }

        .highlight {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
            transition: all 0.3s ease;
            border-radius: 1.5px;
        }

        .content {
            flex: 1; /* Allow content to grow and fill space */
            overflow-y: auto; /* Enable scrolling ONLY within the content area */
            padding: 25px;
            position: relative; /* Needed for absolute positioned pages */
        }

        .page {
            display: none; /* Hide pages by default */
            /* Animation properties */
            position: absolute; /* Position pages for transition (if using complex transitions) */
            width: calc(100% - 50px); /* Account for content padding */
            /* height: calc(100% - 50px); */ /* Let height be auto */
            top: 25px; /* Match content padding */
            left: 25px; /* Match content padding */
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block; /* Show active page */
            position: relative; /* Reset position when active for normal flow */
            width: 100%;
            top: 0;
            left: 0;
        }

        @keyframes fadeIn {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
         }


        h1 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            font-size: 1.8em; /* Slightly larger heading */
        }

        .date-selector {
            display: flex;
            /* justify-content: space-between; */ /* Removed as buttons are gone */
            justify-content: flex-start; /* Align items to the start */
            align-items: center;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.2); /* Slightly more visible */
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            flex-wrap: wrap; /* Allow wrapping */
            gap: 20px; /* Space between items when wrapped */
        }
         #attendance-page .date-selector label {
            font-weight: 500;
            color: var(--text-color);
            margin-right: 5px; /* Space between label and input */
         }

        .date-input {
            padding: 10px 15px; /* Slightly larger padding */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.8); /* More opaque background */
            font-size: 16px;
            flex-grow: 1; /* Allow input to take available space */
            min-width: 180px; /* Ensure minimum width */
        }

        /* Buttons .btn styles removed as they are not in this view */

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: rgba(255, 255, 255, 0.8); /* More opaque */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-color); /* Slightly stronger shadow */
            border: 1px solid var(--border-color);
        }

        thead {
            background: rgba(74, 144, 226, 0.15); /* Slightly darker header */
        }

        th, td {
            padding: 14px 18px; /* Increased padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        th {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.95em;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover td {
            background: rgba(74, 144, 226, 0.08); /* Slightly darker hover */
        }

        /* Select styles removed as status is text */

        /* Status text styles */
        #attendance-tbody .status-present { color: var(--green-color); font-weight: 500; }
        #attendance-tbody .status-absent { color: var(--red-color); font-weight: 500; }
        #attendance-tbody .status-unknown { color: #888; font-style: italic; } /* For missing data */

        .metrics-card {
            background: rgba(255, 255, 255, 0.8); /* More opaque */
            border-radius: 12px; /* Slightly more rounded */
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .metrics-card h2 {
            color: var(--primary-color);
            margin-bottom: 18px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); /* Responsive grid */
            gap: 20px;
        }
        .metrics-grid p {
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        .metrics-grid span {
            font-weight: 600;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 320px; /* Slightly taller charts */
            width: 100%;
            margin-top: 20px;
        }

        .date-history {
            margin-top: 25px;
            margin-bottom: 20px; /* Add some space below chips */
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .date-chip {
            background: rgba(255, 255, 255, 0.3); /* Slightly more visible */
            border-radius: 15px; /* Pill shape */
            padding: 6px 18px; /* Adjust padding */
            font-size: 14px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            color: #555; /* Darker text color */
        }

        .date-chip:hover {
            background: rgba(74, 144, 226, 0.15);
            border-color: rgba(74, 144, 226, 0.4);
            color: var(--primary-color);
        }
        .date-chip.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 500;
        }

        .score-table tr td:last-child { font-weight: 600; }
        .excellent { color: var(--green-color); font-weight: 600; }
        .good { color: #27ae60; font-weight: 600; } /* Slightly different green */
        .average { color: var(--yellow-color); font-weight: 600; }
        .poor { color: #c0392b; font-weight: 600; } /* Slightly different red */

        /* Pulse highlight removed */

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8); /* Slightly more opaque */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Ensure it's on top */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s; /* Delay visibility change */
        }

        .loading.active {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .spinner {
            border: 5px solid rgba(74, 144, 226, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-message {
            color: var(--red-color);
            margin-top: 15px;
            padding: 12px 18px;
            background-color: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            font-weight: 500;
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease;
        }
        .error-message.active { display: block; }

        .toast {
            position: fixed;
            bottom: 25px;
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust centering */
            padding: 15px 25px;
            background: var(--secondary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            /* Initial position for slide up */
            transform: translateX(-50%) translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10001; /* Above loading */
            font-weight: 500;
            min-width: 250px; /* Minimum width */
            text-align: center;
            /* Important: ensure visibility is handled */
            visibility: hidden;
        }

        .toast.show { /* Class to trigger visibility */
             opacity: 1;
             transform: translateX(-50%) translateY(0); /* Slide up effect */
             visibility: visible;
        }
        .toast.hide { /* Class to trigger hiding */
             opacity: 0;
             transform: translateX(-50%) translateY(20px); /* Slide down effect */
             visibility: hidden;
             transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.3s; /* Delay hiding visibility */
        }

        .toast.error { background: var(--red-color); }
        .toast.info { background: var(--primary-color); }


        /* Responsive adjustments */
        @media (max-width: 768px) {
             body { padding: 10px; overflow: auto; } /* Allow body scroll on small screens */
             .container {
                 height: auto; /* Allow container height to adjust */
                 min-height: calc(100vh - 20px);
                 overflow: visible;
                 flex-direction: column; /* Stack topbar and content */
             }
             .content {
                 overflow-y: visible; /* Disable content scroll, use body scroll */
                 padding: 15px;
             }
             .page {
                 position: relative; /* Pages flow normally */
                 width: 100%;
                 top: 0;
                 left: 0;
                 padding: 0;
                 animation: none; /* Disable fade on small screens if preferred */
                 display: none; /* Keep hidden by default */
             }
             .page.active {
                display: block; /* Show active page */
                position: relative; /* Overwrite absolute positioning */
                width: 100%;
                top: 0;
                left: 0;
             }

             .date-selector {
                 flex-direction: column;
                 gap: 15px;
                 align-items: stretch;
             }
             /* .date-selector > div { justify-content: space-between; width: 100%; } Removed as buttons are gone */
             .date-input { width: 100%; }

             /* Mobile Table Styles */
             table, thead, tbody, th, td, tr {
                 display: block;
             }
             thead tr {
                 position: absolute;
                 top: -9999px;
                 left: -9999px;
             }
             tr {
                 border: 1px solid #ccc;
                 margin-bottom: 15px; /* Increased spacing */
                 border-radius: 8px;
                 background: rgba(255,255,255,0.85);
                 padding: 10px; /* Add padding inside the row block */
             }
             td {
                 border: none;
                 border-bottom: 1px solid #eee;
                 position: relative;
                 padding-left: 45%; /* Space for label */
                 text-align: right;
                 min-height: 38px; /* Ensure minimum height for alignment */
                 display: flex; /* Use flex for alignment */
                 align-items: center; /* Vertically center content */
                 justify-content: flex-end; /* Align content to the right */
             }
             td:before {
                 position: absolute;
                 top: 50%;
                 left: 15px;
                 transform: translateY(-50%);
                 width: 40%;
                 padding-right: 10px;
                 white-space: nowrap;
                 text-align: left;
                 font-weight: bold;
                 color: var(--primary-color);
                 font-size: 0.9em;
             }
             td:last-child { border-bottom: 0; }

             /* Specific labels for tables using CSS variables assigned in JS or directly */
             #attendance-table td:nth-of-type(1):before { content: "Roll No"; }
             #attendance-table td:nth-of-type(2):before { content: "Name"; }
             #attendance-table td:nth-of-type(3):before { content: "Status"; }
             #attendance-table td:nth-of-type(3) { justify-content: flex-end; } /* Ensure text aligns right */


             #metrics-table td:nth-of-type(1):before { content: "Roll No"; }
             #metrics-table td:nth-of-type(2):before { content: "Name"; }
             #metrics-table td:nth-of-type(3):before { content: "Present"; }
             #metrics-table td:nth-of-type(4):before { content: "Absent"; }
             #metrics-table td:nth-of-type(5):before { content: "Attend %"; }

             #ranking-table td:nth-of-type(1):before { content: "Rank"; }
             #ranking-table td:nth-of-type(2):before { content: "Roll No"; }
             #ranking-table td:nth-of-type(3):before { content: "Name"; }
             #ranking-table td:nth-of-type(4):before { content: "Attend %"; }

             /* td select.attendance-select { width: auto; min-width: 120px; }  Removed as no selects here */

             .nav-item { padding: 8px 15px; font-size: 20px; }
             .highlight { height: 2px; }
             .toast { width: calc(100% - 30px); bottom: 15px; left: 15px; transform: translateX(0) translateY(20px); } /* Adjust initial position for mobile */
             .toast.show { transform: translateX(0) translateY(0); } /* Adjust slide up */
             .toast.hide { transform: translateX(0) translateY(20px); } /* Adjust slide down */
             .metrics-grid { grid-template-columns: 1fr; } /* Single column */
        }
        /* Embedded CSS End */
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="nav-item active" data-page="attendance" title="Attendance"><i class="fas fa-calendar-check"></i></div>
            <div class="nav-item" data-page="metrics" title="Metrics"><i class="fas fa-chart-bar"></i></div>
            <div class="nav-item" data-page="ranking" title="Ranking"><i class="fas fa-trophy"></i></div>
            <div class="highlight"></div>
        </div>

        <div class="content">
            <!-- Attendance Page -->
            <div id="attendance-page" class="page active">
                <h1>Daily Attendance View</h1>
                 <div class="date-selector">
                    <label for="attendance-date">Select Date to View:</label>
                    <input type="date" id="attendance-date" class="date-input">
                </div>
                <div id="attendance-error" class="error-message"></div>
                <div class="date-history" id="date-history">
                    <!-- Date chips will be loaded here -->
                </div>
                <table id="attendance-table">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-tbody">
                        <!-- Rows will be loaded by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Metrics Page -->
            <div id="metrics-page" class="page">
                <h1>Attendance Metrics</h1>
                <div class="metrics-card">
                    <h2>Overall Statistics</h2>
                    <div class="metrics-grid">
                        <div>
                            <p>Total Classes Marked: <span id="total-classes">0</span></p>
                            <p>Overall Avg. Attendance: <span id="avg-attendance">0%</span></p>
                        </div>
                        <div>
                            <p>Highest Attendance Day: <span id="best-day">-</span></p>
                            <p>Lowest Attendance Day: <span id="worst-day">-</span></p>
                        </div>
                    </div>
                </div>
                <div class="metrics-card">
                    <h2>Student Attendance Report</h2>
                    <table id="metrics-table">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Student Name</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-tbody"></tbody>
                    </table>
                </div>
                <div class="metrics-card">
                    <h2>Attendance Trend Over Time</h2>
                    <div class="chart-container">
                        <canvas id="attendance-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ranking Page -->
            <div id="ranking-page" class="page">
                <h1>Student Rankings</h1>
                <div class="metrics-card">
                    <h2>Attendance Leaderboard</h2>
                    <table class="score-table" id="ranking-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Roll No</th>
                                <th>Student Name</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-tbody"></tbody>
                    </table>
                </div>
                 <div class="metrics-card">
                    <h2>Attendance Performance Distribution</h2>
                    <div class="chart-container">
                        <canvas id="distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading-spinner">
        <div class="spinner"></div>
    </div>
    <div class="toast" id="toast-message"></div>

    <script>
        // Embedded JavaScript Start
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const TOAST_DURATION = 3000;

            // --- Global State ---
            let attendanceCharts = {}; // {chart_id: chart_instance}
            let currentPage = "attendance";
            const pageIds = {"attendance": "attendance-page", "metrics": "metrics-page", "ranking": "ranking-page"};
            let toastTimerId = null;
            let currentStudents = []; // Cache the student list

            // --- DOM Element References ---
            const loadingSpinner = document.getElementById('loading-spinner');
            const toastMessageElement = document.getElementById('toast-message');
            const attendanceTbody = document.getElementById('attendance-tbody');
            const attendanceDateInput = document.getElementById('attendance-date');
            const attendanceErrorElement = document.getElementById('attendance-error');
            const dateHistoryElement = document.getElementById('date-history');
            const totalClassesElement = document.getElementById('total-classes');
            const avgAttendanceElement = document.getElementById('avg-attendance');
            const bestDayElement = document.getElementById('best-day');
            const worstDayElement = document.getElementById('worst-day');
            const metricsTbody = document.getElementById('metrics-tbody');
            const rankingTbody = document.getElementById('ranking-tbody');
            const contentElement = document.querySelector('.content');
            const navItems = document.querySelectorAll('.nav-item');
            const highlightElement = document.querySelector('.highlight');

            // --- Utility Functions ---
            function getTodayDate() {
                return new Date().toISOString().split('T')[0];
            }

            function showLoading(show = true) {
                loadingSpinner.classList.toggle("active", show);
            }

            function showToast(message, type = "info", duration = TOAST_DURATION) { // Default to info
                toastMessageElement.textContent = message;
                toastMessageElement.className = `toast ${type}`;
                if (toastTimerId) clearTimeout(toastTimerId);
                toastMessageElement.offsetHeight; // Reflow
                toastMessageElement.classList.add("show");
                toastMessageElement.classList.remove("hide");
                toastTimerId = setTimeout(() => hideToast(toastMessageElement), duration);
            }

            function hideToast(toastElement) {
                toastElement.classList.add("hide");
                toastElement.classList.remove("show");
                toastTimerId = null;
            }

             function showError(elementId, message = "", show = true) {
                const errorElement = document.getElementById(elementId);
                if (!errorElement) return;
                errorElement.textContent = message;
                errorElement.classList.toggle("active", show);
            }

            function destroyChart(chartId) {
                if (attendanceCharts[chartId]) {
                    try {
                        attendanceCharts[chartId].destroy();
                        attendanceCharts[chartId] = null;
                    } catch (e) {
                        console.error(`Error destroying chart '${chartId}': ${e}`);
                    }
                }
            }

            // --- API Fetch Wrapper ---
            async function fetchData(url, options = {}) {
                showLoading(true);
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        let errorMsg = `HTTP error! status: ${response.status}`;
                        try {
                            const errData = await response.json();
                            errorMsg += `: ${errData.message || 'Unknown server error'}`;
                        } catch (e) { /* Ignore if response is not JSON */ }
                        throw new Error(errorMsg);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Fetch error for ${url}:`, error);
                    showToast(`Error fetching data: ${error.message}`, "error", 5000);
                    throw error; // Re-throw for caller handling
                } finally {
                    showLoading(false);
                }
            }

            // --- Data Loading and Display ---

            async function fetchStudents() {
                try {
                     currentStudents = await fetchData('/api/students');
                     console.log("Fetched students:", currentStudents.length);
                } catch (error) {
                    showError('attendance-error', 'Failed to load student list. Cannot display attendance.', true);
                    currentStudents = []; // Clear student list on error
                }
            }

            function buildAttendanceTableStructure() {
                attendanceTbody.innerHTML = ""; // Clear existing rows
                if (!currentStudents || currentStudents.length === 0) {
                     attendanceTbody.innerHTML = '<tr><td colspan="3">No student list available.</td></tr>';
                     return;
                }
                currentStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.dataset.roll = student.roll_no;
                    row.innerHTML = `
                        <td data-label="Roll No">${student.roll_no}</td>
                        <td data-label="Name">${student.name}</td>
                        <td data-label="Status" class="status-cell">-</td> <!-- Placeholder status -->
                    `;
                    attendanceTbody.appendChild(row);
                });
            }


            async function loadAttendance(date) {
                if (!date) {
                    showToast("Please select a date to view.", "info");
                    attendanceTbody.querySelectorAll('.status-cell').forEach(cell => {
                         cell.textContent = '-';
                         cell.className = 'status-cell';
                    });
                    return;
                }
                 if (!currentStudents || currentStudents.length === 0) {
                     showError('attendance-error', 'Student list not loaded. Cannot display attendance.', true);
                     return;
                 }

                console.log(`Fetching attendance for date: ${date}`);
                showError('attendance-error', '', false);

                try {
                    const dateData = await fetchData(`/api/attendance/${date}`);

                    attendanceTbody.querySelectorAll('.status-cell').forEach(cell => {
                         cell.textContent = 'N/A';
                         cell.className = 'status-cell status-unknown';
                    });


                    if (dateData && dateData.length > 0) {
                        dateData.forEach(studentAttendance => {
                            const rollNo = studentAttendance.roll_no;
                            const status = studentAttendance.status;
                            const row = attendanceTbody.querySelector(`tr[data-roll="${rollNo}"]`);
                            if (row) {
                                const statusCell = row.querySelector('.status-cell');
                                if (statusCell) {
                                    statusCell.textContent = status === 'present' ? 'Present' : 'Absent';
                                    statusCell.className = `status-cell status-${status}`;
                                }
                            } else {
                                console.warn(`Attendance data found for non-existent student roll no: ${rollNo} on date ${date}`);
                            }
                        });
                    } else {
                         showToast(`No attendance record found for ${date}.`, "info", 2000);
                    }
                } catch (error) {
                    showError('attendance-error', `Failed to load attendance for ${date}.`, true);
                    attendanceTbody.querySelectorAll('.status-cell').forEach(cell => {
                         cell.textContent = 'Error';
                         cell.className = 'status-cell status-absent';
                    });
                }
            }

            async function updateDateHistory() {
                dateHistoryElement.innerHTML = "";
                try {
                    const dates = await fetchData('/api/attendance/dates');
                    if (dates && dates.length > 0) {
                        dates.forEach(date => {
                            const chip = document.createElement('div');
                            chip.className = 'date-chip';
                            chip.textContent = date;
                            chip.dataset.date = date;
                            chip.addEventListener('click', () => loadAttendanceForDate(date));
                            dateHistoryElement.appendChild(chip);
                        });
                    } else {
                        dateHistoryElement.innerHTML = '<p>No attendance records yet.</p>';
                    }
                    highlightActiveDateChip();
                } catch (error) {
                    dateHistoryElement.innerHTML = '<p style="color: var(--red-color);">Failed to load date history.</p>';
                }
            }

             function highlightActiveDateChip() {
                 const currentDate = attendanceDateInput.value;
                 document.querySelectorAll(".date-chip").forEach(chip => {
                     chip.classList.toggle("active", chip.dataset.date === currentDate);
                 });
             }

            function loadAttendanceForDate(date) {
                console.log(`Date chip clicked: ${date}`);
                attendanceDateInput.value = date;
                highlightActiveDateChip();
                loadAttendance(date);
            }

            // --- Metrics Page Functions ---
            async function updateMetrics() {
                console.log("Updating metrics view...");
                totalClassesElement.textContent = "0";
                avgAttendanceElement.textContent = "0%";
                bestDayElement.textContent = "-";
                worstDayElement.textContent = "-";
                metricsTbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
                destroyChart("attendance_chart");

                try {
                    const overallMetrics = await fetchData('/api/metrics');
                    totalClassesElement.textContent = overallMetrics.totalClasses || "0";
                    avgAttendanceElement.textContent = overallMetrics.avgAttendance || "0%";
                    bestDayElement.textContent = overallMetrics.bestDay || "-";
                    worstDayElement.textContent = overallMetrics.worstDay || "-";

                     if (overallMetrics.dailyRates && Object.keys(overallMetrics.dailyRates).length > 0) {
                        updateAttendanceChart(overallMetrics.dailyRates);
                     } else {
                         const canvas = document.getElementById("attendance-chart");
                         if(canvas) {
                             const ctx = canvas.getContext("2d");
                             ctx.clearRect(0, 0, canvas.width, canvas.height);
                         }
                     }

                    const studentMetricsData = await fetchData('/api/metrics/students');
                    metricsTbody.innerHTML = "";

                    if (studentMetricsData && studentMetricsData.length > 0) {
                        studentMetricsData.forEach(metrics => {
                            const attendancePercent = parseFloat(metrics.attendance_percent);
                            let percentClass = "poor";
                            if (attendancePercent >= 90) percentClass = "excellent";
                            else if (attendancePercent >= 75) percentClass = "good";
                            else if (attendancePercent >= 60) percentClass = "average";

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td data-label="Roll No">${metrics.roll_no}</td>
                                <td data-label="Name">${metrics.name}</td>
                                <td data-label="Present">${metrics.present}</td>
                                <td data-label="Absent">${metrics.absent}</td>
                                <td data-label="Attend %" class="${percentClass}">${metrics.attendance_percent}%</td>
                            `;
                            metricsTbody.appendChild(row);
                        });
                    } else {
                        metricsTbody.innerHTML = '<tr><td colspan="5">No detailed student metrics available.</td></tr>';
                    }
                     console.log("Metrics view updated.");

                } catch (error) {
                    console.error("Error updating metrics view:", error);
                    metricsTbody.innerHTML = `<tr><td colspan="5" style="color: var(--red-color);">Failed to load metrics data.</td></tr>`;
                    destroyChart("attendance_chart");
                }
            }

             // --- Rankings Page Functions ---
            async function updateRankings() {
                console.log("Updating rankings view...");
                rankingTbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
                destroyChart("distribution_chart");

                try {
                    const rankingData = await fetchData('/api/rankings');
                    rankingTbody.innerHTML = "";

                    if (rankingData && rankingData.length > 0) {
                         rankingData.forEach(summary => {
                            const percent = parseFloat(summary.attendance_percent);
                            let rankClass = "poor";
                            if (percent >= 90) rankClass = "excellent";
                            else if (percent >= 75) rankClass = "good";
                            else if (percent >= 60) rankClass = "average";

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td data-label="Rank">${summary.rank}</td>
                                <td data-label="Roll No">${summary.roll_no}</td>
                                <td data-label="Name">${summary.name}</td>
                                <td data-label="Attend %" class="${rankClass}">${summary.attendance_percent}%</td>
                            `;
                            rankingTbody.appendChild(row);
                        });
                         updateDistributionChart(rankingData);

                    } else {
                        rankingTbody.innerHTML = '<tr><td colspan="4">No ranking data available.</td></tr>';
                        const canvas = document.getElementById("distribution-chart");
                        if(canvas) {
                            const ctx = canvas.getContext("2d");
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                    }
                    console.log("Rankings view updated.");

                } catch (error) {
                    console.error("Error updating rankings view:", error);
                    rankingTbody.innerHTML = `<tr><td colspan="4" style="color: var(--red-color);">Failed to load ranking data.</td></tr>`;
                    destroyChart("distribution_chart");
                }
            }

            // --- Chart Update Functions ---
            function updateAttendanceChart(dailyRates) {
                const chartId = "attendance_chart";
                const canvasId = "attendance-chart";
                destroyChart(chartId);

                if (!dailyRates || Object.keys(dailyRates).length === 0) {
                    console.log("No data for attendance chart.");
                    return;
                }

                try {
                    const sortedDates = Object.keys(dailyRates).sort();
                    const attendanceRates = sortedDates.map(date => dailyRates[date]);
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    const ctx = canvas.getContext("2d");

                    attendanceCharts[chartId] = new Chart(ctx, {
                        type: "line",
                        data: {
                             labels: sortedDates,
                             datasets: [{
                                label: "Daily Attendance Rate (%)",
                                data: attendanceRates,
                                backgroundColor: "rgba(74, 144, 226, 0.15)",
                                borderColor: "rgba(74, 144, 226, 1)",
                                borderWidth: 2.5,
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: "rgba(74, 144, 226, 1)",
                                pointRadius: 4,
                                pointHoverRadius: 6
                             }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, title: { display: true, text: "Attendance Rate (%)" } },
                                x: { title: { display: true, text: "Date" } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    mode: "index", intersect: false,
                                    callbacks: {
                                        title: (items) => items[0]?.label ?? '',
                                        label: (context) => `Attendance: ${context.parsed.y.toFixed(1)}%`
                                    }
                                }
                            },
                            interaction: { mode: 'index', intersect: false }
                        }
                    });
                } catch (e) {
                    console.error(`Error updating attendance chart: ${e}`);
                    showToast("Could not display attendance trend chart", "error");
                }
            }

            function updateDistributionChart(rankingData) {
                const chartId = "distribution_chart";
                const canvasId = "distribution-chart";
                destroyChart(chartId);

                if (!rankingData || rankingData.length === 0) {
                    console.log("No data for distribution chart.");
                    return;
                }

                try {
                    const ranges = { "Excellent (>=90%)": 0, "Good (75-89%)": 0, "Average (60-74%)": 0, "Poor (<60%)": 0 };
                    rankingData.forEach(summary => {
                        const percent = parseFloat(summary.attendance_percent);
                        if (percent >= 90) ranges["Excellent (>=90%)"]++;
                        else if (percent >= 75) ranges["Good (75-89%)"]++;
                        else if (percent >= 60) ranges["Average (60-74%)"]++;
                        else ranges["Poor (<60%)"]++;
                    });

                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    const ctx = canvas.getContext("2d");
                    const computedStyle = getComputedStyle(document.documentElement);
                    const colors = [
                        computedStyle.getPropertyValue('--green-color').trim() || 'rgba(6, 214, 160, 0.85)',
                        computedStyle.getPropertyValue('--secondary-color').trim() || 'rgba(39, 174, 96, 0.85)',
                        computedStyle.getPropertyValue('--yellow-color').trim() || 'rgba(241, 196, 15, 0.85)',
                        computedStyle.getPropertyValue('--red-color').trim() || 'rgba(192, 57, 43, 0.85)'
                    ];

                    attendanceCharts[chartId] = new Chart(ctx, {
                        type: "pie",
                        data: {
                             labels: Object.keys(ranges),
                             datasets: [{
                                label: "Number of Students",
                                data: Object.values(ranges),
                                backgroundColor: colors,
                                borderColor: "rgba(255, 255, 255, 0.7)",
                                borderWidth: 1.5
                             }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { padding: 20, boxWidth: 15, usePointStyle: true }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.label}: ${context.raw} students`,
                                        afterLabel: (context) => {
                                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                            return total > 0 ? `${((context.raw / total) * 100).toFixed(1)}% of total` : "";
                                        }
                                    }
                                },
                                title: { display: false }
                            }
                        }
                    });
                } catch (e) {
                    console.error(`Error updating distribution chart: ${e}`);
                    showToast("Could not display distribution chart", "error");
                }
            }

            // --- Navigation ---
            function switchPage(targetPageId) {
                if (targetPageId === currentPage) return;
                console.log(`Switching page to ${targetPageId}`);

                Object.values(pageIds).forEach(pageDomId => {
                    document.getElementById(pageDomId)?.classList.toggle("active", pageDomId === pageIds[targetPageId]);
                });
                navItems.forEach(item => {
                    item.classList.toggle("active", item.dataset.page === targetPageId);
                });

                currentPage = targetPageId;
                updateHighlight();

                if (targetPageId === "metrics") {
                    updateMetrics();
                } else if (targetPageId === "ranking") {
                    updateRankings();
                } else if (targetPageId === "attendance") {
                     updateDateHistory();
                     highlightActiveDateChip();
                }
            }

            function onNavClick(event) {
                const targetPage = event.currentTarget.dataset.page;
                if (targetPage) switchPage(targetPage);
            }

             function updateHighlight() {
                const activeNav = document.querySelector(".nav-item.active");
                if (activeNav && highlightElement) {
                    highlightElement.style.left = `${activeNav.offsetLeft}px`;
                    highlightElement.style.width = `${activeNav.offsetWidth}px`;
                } else if (highlightElement) {
                    highlightElement.style.width = `0px`;
                }
            }

            // --- Event Handlers ---
            function onDateChange(event) {
                const date = event.target.value;
                console.log(`Date changed to: ${date}`);
                loadAttendance(date);
                highlightActiveDateChip();
                showError("attendance-error", "", false);
            }

            // --- Initialization ---
            async function initApp() {
                console.log("Initializing Student Attendance View (JS)...");
                showLoading(true);

                const today = getTodayDate();
                attendanceDateInput.value = today;
                attendanceDateInput.max = today;

                navItems.forEach(item => item.addEventListener('click', onNavClick));
                attendanceDateInput.addEventListener('change', onDateChange);
                window.addEventListener('resize', updateHighlight);

                try {
                     await fetchStudents();
                     buildAttendanceTableStructure();
                     await updateDateHistory();
                     await loadAttendance(today);
                    setTimeout(updateHighlight, 150);
                    showToast("Attendance view ready", "success", 1500);

                } catch (e) {
                    console.error(`Critical Error during app initialization: ${e}`);
                    showToast("Error initializing application!", "error", 5000);
                     showError('attendance-error', `Initialization failed: ${e.message}`, true);
                    if (contentElement) {
                         contentElement.innerHTML = `<h1>Initialization Error</h1><p>Could not start the application. Please check the console (F12) for details.</p><p>Error: ${e.message}</p>`;
                    }
                } finally {
                    showLoading(false);
                }
            }

            // --- Start the application ---
            initApp();

        });
        // Embedded JavaScript End
    </script>
</body>
</html>