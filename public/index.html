<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance (View)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* --- Styles largely unchanged, adding subject filter select --- */
         :root {
            --primary-color: #4a90e2;
            --secondary-color: #50c878;
            --background-color: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --red-color: #ff6b6b;
            --yellow-color: #ffd166;
            --green-color: #06d6a0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; overflow: hidden; }
        .container { display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); border: 1px solid var(--border-color); overflow: hidden; height: calc(100vh - 40px); }
        .topbar { display: flex; justify-content: space-around; align-items: center; padding: 10px 0; background: rgba(255, 255, 255, 0.2); border-bottom: 1px solid var(--border-color); position: relative; flex-shrink: 0; }
        .nav-item { padding: 10px 20px; cursor: pointer; transition: all 0.3s ease; color: var(--text-color); font-size: 24px; text-align: center; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item:hover:not(.active) { color: var(--primary-color); opacity: 0.8; }
        .highlight { position: absolute; bottom: 0; height: 3px; background: var(--primary-color); box-shadow: 0 0 8px var(--primary-color); transition: all 0.3s ease; border-radius: 1.5px; }
        .content { flex: 1; overflow-y: auto; padding: 25px; position: relative; }
        .page { display: none; position: absolute; width: calc(100% - 50px); top: 25px; left: 25px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; position: relative; width: 100%; top: 0; left: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: var(--primary-color); margin-bottom: 25px; font-weight: 600; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px; font-size: 1.8em; }

        .controls-container { /* NEW: Wrapper for subject filter and date */
            display: flex;
            flex-direction: column; /* Stack vertically */
            gap: 15px; /* Space between rows */
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .control-row { /* NEW: Row for subject or date */
             display: flex;
             align-items: center;
             gap: 15px;
             flex-wrap: wrap;
        }
        .control-row label {
            font-weight: 500;
            color: var(--text-color);
            flex-shrink: 0;
            min-width: 90px; /* Slightly wider label */
        }
        .subject-filter-select, .date-input { /* Shared styles */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            flex-grow: 1;
            min-width: 180px;
        }
        @media (min-width: 769px) { /* On larger screens, put controls side-by-side */
             .controls-container { flex-direction: row; justify-content: space-between; align-items: center; gap: 20px;}
             .control-row { flex-grow: 1; } /* Allow rows to grow */
             .control-row.date-row { max-width: 300px; } /* Limit date input width */
        }

        /* Table, Metrics, Loading, Toast styles unchanged */
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px var(--shadow-color); border: 1px solid var(--border-color); }
        thead { background: rgba(74, 144, 226, 0.15); }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { font-weight: 600; color: var(--primary-color); font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: rgba(74, 144, 226, 0.08); }
        .status-present { color: var(--green-color); font-weight: 600; text-transform: capitalize; }
        .status-absent { color: var(--red-color); font-weight: 600; text-transform: capitalize; }
        .status-unknown { color: #888; font-style: italic; }
        .status-select-subject { color: #555; font-style: italic; } /* Style for when 'All Subjects' is chosen */

        .metrics-card { background: rgba(255, 255, 255, 0.8); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 15px var(--shadow-color); border: 1px solid var(--border-color); }
        .metrics-card h2 { color: var(--primary-color); margin-bottom: 18px; font-size: 1.3em; font-weight: 600; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; }
        .metrics-grid p { margin-bottom: 8px; font-size: 1.05em; }
        .metrics-grid span { font-weight: 600; color: var(--primary-color); }
        .chart-container { position: relative; height: 320px; width: 100%; margin-top: 20px; }
        .date-history { margin-top: 25px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; }
        .date-chip { background: rgba(255, 255, 255, 0.3); border-radius: 15px; padding: 6px 18px; font-size: 14px; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.3s ease; color: #555; }
        .date-chip:hover { background: rgba(74, 144, 226, 0.15); border-color: rgba(74, 144, 226, 0.4); color: var(--primary-color); }
        .date-chip.active { background: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 500; }
        .score-table tr td:last-child { font-weight: 600; }
        .excellent { color: var(--green-color); font-weight: 600; }
        .good { color: #27ae60; font-weight: 600; }
        .average { color: var(--yellow-color); font-weight: 600; }
        .poor { color: #c0392b; font-weight: 600; }
        .loading { /* ... */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .loading.active { /* ... */ visibility: visible; opacity: 1; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .spinner { /* ... */ border: 5px solid rgba(74, 144, 226, 0.2); border-radius: 50%; border-top-color: var(--primary-color); width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { /* ... */ color: var(--red-color); margin-top: 15px; padding: 12px 18px; background-color: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; font-weight: 500; display: none; transition: opacity 0.3s ease; }
        .error-message.active { display: block; }
        .toast { /* ... */ position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: var(--secondary-color); color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); opacity: 0; transform: translateX(-50%) translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; z-index: 10001; font-weight: 500; min-width: 250px; text-align: center; visibility: hidden; }
        .toast.show { /* ... */ opacity: 1; transform: translateX(-50%) translateY(0); visibility: visible; }
        .toast.hide { /* ... */ opacity: 0; transform: translateX(-50%) translateY(20px); visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.3s; }
        .toast.error { background: var(--red-color); }
        .toast.info { background: var(--primary-color); }

        /* Responsive adjustments */
        @media (max-width: 768px) {
             body { padding: 10px; overflow: auto; }
             .container { height: auto; min-height: calc(100vh - 20px); overflow: visible; flex-direction: column; }
             .content { overflow-y: visible; padding: 15px; }
             .page { position: relative; width: 100%; top: 0; left: 0; padding: 0; animation: none; display: none; }
             .page.active { display: block; position: relative; width: 100%; top: 0; left: 0; }
             /* Controls container already stacked */
             .control-row { flex-direction: column; align-items: stretch; }
             .control-row label { margin-bottom: 5px; min-width: unset; }
             .subject-filter-select, .date-input { width: 100%; }

             /* Mobile Table Styles (Unchanged) */
             table, thead, tbody, th, td, tr { display: block; }
             thead tr { position: absolute; top: -9999px; left: -9999px; }
             tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; background: rgba(255,255,255,0.85); padding: 10px; }
             td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 45%; text-align: right; min-height: 38px; display: flex; align-items: center; justify-content: flex-end; }
             td:before { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--primary-color); font-size: 0.9em; }
             td:last-child { border-bottom: 0; }
             #attendance-table td:nth-of-type(1):before { content: "Roll No"; }
             #attendance-table td:nth-of-type(2):before { content: "Name"; }
             #attendance-table td:nth-of-type(3):before { content: "Status"; }
             #metrics-table td:nth-of-type(1):before { content: "Roll No"; }
             #metrics-table td:nth-of-type(2):before { content: "Name"; }
             #metrics-table td:nth-of-type(3):before { content: "Present"; }
             #metrics-table td:nth-of-type(4):before { content: "Absent"; }
             #metrics-table td:nth-of-type(5):before { content: "Attend %"; }
             #ranking-table td:nth-of-type(1):before { content: "Rank"; }
             #ranking-table td:nth-of-type(2):before { content: "Roll No"; }
             #ranking-table td:nth-of-type(3):before { content: "Name"; }
             #ranking-table td:nth-of-type(4):before { content: "Attend %"; }

             .nav-item { padding: 8px 15px; font-size: 20px; }
             .highlight { height: 2px; }
             .toast { width: calc(100% - 30px); bottom: 15px; left: 15px; transform: translateX(0) translateY(20px); }
             .toast.show { transform: translateX(0) translateY(0); }
             .toast.hide { transform: translateX(0) translateY(20px); }
             .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="nav-item active" data-page="attendance" title="Attendance"><i class="fas fa-calendar-check"></i></div>
            <div class="nav-item" data-page="metrics" title="Metrics"><i class="fas fa-chart-bar"></i></div>
            <div class="nav-item" data-page="ranking" title="Ranking"><i class="fas fa-trophy"></i></div>
            <div class="highlight"></div>
        </div>

        <div class="content">
            <!-- Attendance Page -->
            <div id="attendance-page" class="page active">
                <h1>Semester 6 (Physics) - Attendance View</h1>

                <!-- MODIFIED: Controls wrapped -->
                <div class="controls-container">
                     <div class="control-row">
                         <label for="subject-filter-select">Filter Subject:</label>
                         <select id="subject-filter-select" class="subject-filter-select">
                             <option value="all">-- All Subjects --</option>
                             <!-- Options populated by JS -->
                         </select>
                     </div>
                     <div class="control-row date-row">
                         <label for="attendance-date">View Date:</label>
                         <input type="date" id="attendance-date" class="date-input">
                     </div>
                 </div>

                <!-- Error message placeholder -->
                <div id="attendance-error" class="error-message"></div>
                 <!-- History of recorded dates -->
                <div class="date-history" id="date-history"></div>
                <!-- Attendance Table -->
                <table id="attendance-table">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-tbody"></tbody>
                </table>
            </div>

            <!-- Metrics Page -->
            <div id="metrics-page" class="page">
                <!-- MODIFIED: Title might need update based on filter -->
                <h1 id="metrics-title">Attendance Metrics</h1>
                <div class="metrics-card">
                    <h2>Overall Statistics (<span id="metrics-subject-filter-display">All Subjects</span>)</h2>
                    <div class="metrics-grid">
                        <div>
                            <p>Total Classes Marked: <span id="total-classes">0</span></p>
                            <p>Overall Avg. Attendance: <span id="avg-attendance">0%</span></p>
                        </div>
                        <div>
                            <p>Highest Attendance Day: <span id="best-day">-</span></p>
                            <p>Lowest Attendance Day: <span id="worst-day">-</span></p>
                        </div>
                    </div>
                </div>
                <div class="metrics-card">
                    <h2>Student Report (<span id="metrics-table-subject-display">All Subjects</span>)</h2>
                    <table id="metrics-table">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Student Name</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-tbody"></tbody>
                    </table>
                </div>
                <div class="metrics-card">
                    <h2>Attendance Trend (<span id="metrics-chart-subject-display">All Subjects</span>)</h2>
                    <div class="chart-container">
                        <canvas id="attendance-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ranking Page -->
            <div id="ranking-page" class="page">
                 <!-- MODIFIED: Title might need update based on filter -->
                <h1 id="ranking-title">Student Rankings</h1>
                <div class="metrics-card">
                    <h2>Leaderboard (<span id="ranking-table-subject-display">All Subjects</span>)</h2>
                    <table class="score-table" id="ranking-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Roll No</th>
                                <th>Student Name</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-tbody"></tbody>
                    </table>
                </div>
                 <div class="metrics-card">
                    <h2>Distribution (<span id="ranking-chart-subject-display">All Subjects</span>)</h2>
                    <div class="chart-container">
                        <canvas id="distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div> <!-- End Content -->
    </div> <!-- End Container -->

    <!-- Loading Spinner -->
    <div class="loading" id="loading-spinner"></div>
    <!-- Toast Message -->
    <div class="toast" id="toast-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Configuration ---
            const API_BASE_URL = '';
            const TOAST_DURATION = 3000;

            // --- Global State ---
            let STUDENTS = [];
            let attendanceData = {}; // Cache: { subject: { date: [...] } }
            let attendanceCharts = {};
            let currentPage = "attendance";
            const pageIds = {"attendance": "attendance-page", "metrics": "metrics-page", "ranking": "ranking-page"};
            let toastTimerId = null;
            let currentSubjectFilter = 'all'; // *** NEW *** Default filter

            // --- DOM Element References ---
            const loadingSpinner = document.getElementById('loading-spinner');
            const toastMessageElement = document.getElementById('toast-message');
            const attendanceTbody = document.getElementById('attendance-tbody');
            const subjectFilterSelect = document.getElementById('subject-filter-select'); // *** NEW ***
            const attendanceDateInput = document.getElementById('attendance-date');
            const attendanceErrorElement = document.getElementById('attendance-error');
            const dateHistoryElement = document.getElementById('date-history');
            // Metrics/Ranking elements (including new subject display spans)
            const metricsTitle = document.getElementById('metrics-title');
            const rankingTitle = document.getElementById('ranking-title');
            const totalClassesElement = document.getElementById('total-classes');
            const avgAttendanceElement = document.getElementById('avg-attendance');
            const bestDayElement = document.getElementById('best-day');
            const worstDayElement = document.getElementById('worst-day');
            const metricsTbody = document.getElementById('metrics-tbody');
            const rankingTbody = document.getElementById('ranking-tbody');
             // Spans to show current filter context
            const metricsSubjectSpans = [
                document.getElementById('metrics-subject-filter-display'),
                document.getElementById('metrics-table-subject-display'),
                document.getElementById('metrics-chart-subject-display')
            ].filter(Boolean); // Filter out nulls if IDs change
             const rankingSubjectSpans = [
                document.getElementById('ranking-table-subject-display'),
                document.getElementById('ranking-chart-subject-display')
            ].filter(Boolean);

            const contentElement = document.querySelector('.content');
            const navItems = document.querySelectorAll('.nav-item');
            const highlightElement = document.querySelector('.highlight');

            // --- Utility Functions (Unchanged) ---
            function getTodayDate() { return new Date().toISOString().split('T')[0]; }
            function showLoading(show = true) { loadingSpinner.classList.toggle("active", show); }
            function showToast(message, type = "success", duration = TOAST_DURATION) { /* ... same ... */
                 toastMessageElement.textContent = message;
                 toastMessageElement.className = `toast ${type}`;
                 if (toastTimerId) clearTimeout(toastTimerId);
                 requestAnimationFrame(() => {
                     toastMessageElement.classList.add("show");
                     toastMessageElement.classList.remove("hide");
                 });
                 toastTimerId = setTimeout(() => hideToast(toastMessageElement), duration);
             }
            function hideToast(toastElement) { /* ... same ... */
                 toastElement.classList.add("hide");
                 toastElement.classList.remove("show");
                 toastTimerId = null;
             }
            function showError(elementId, message = "", show = true) { /* ... same ... */
                 const errorElement = document.getElementById(elementId);
                 if (!errorElement) return;
                 errorElement.textContent = message;
                 errorElement.classList.toggle("active", show && message);
             }
            function consoleLog(message) { console.log(`Frontend App: ${message}`); }

            // --- Data Fetching (Unchanged API call, expects nested data) ---
            async function fetchData() {
                 consoleLog("Fetching initial data from server...");
                 showLoading(true);
                 try {
                    const [studentsRes, attendanceRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/api/students`),
                        fetch(`${API_BASE_URL}/api/attendance`) // Expects { subject: { date: [...] } }
                    ]);
                    if (!studentsRes.ok) throw new Error(`Failed to fetch students: ${studentsRes.statusText}`);
                    if (!attendanceRes.ok) throw new Error(`Failed to fetch attendance: ${attendanceRes.statusText}`);
                    STUDENTS = await studentsRes.json();
                    attendanceData = await attendanceRes.json(); // Store the nested structure
                    consoleLog(`Data fetched: ${STUDENTS.length} students, ${Object.keys(attendanceData).length} subjects.`);
                    showToast("Data loaded successfully", "success", 1500);
                    return true;
                 } catch (error) {
                    console.error("Error fetching data:", error);
                    showError("attendance-error", `Failed to load data from server: ${error.message}`, true);
                    showToast("Error loading data", "error", 5000);
                    STUDENTS = []; attendanceData = {};
                    return false;
                 } finally {
                    showLoading(false);
                 }
            }

             // *** NEW *** Populate subject filter dropdown
             function populateSubjectFilter() {
                 subjectFilterSelect.innerHTML = '<option value="all">-- All Subjects --</option>'; // Clear existing
                 const subjects = Object.keys(attendanceData).sort(); // Get subjects from data
                 subjects.forEach(subj => {
                     const option = document.createElement('option');
                     option.value = subj;
                     option.textContent = subj;
                     subjectFilterSelect.appendChild(option);
                 });
                 // Set selected value based on current filter state
                 subjectFilterSelect.value = currentSubjectFilter;
             }

            // --- Attendance Page Functions (MODIFIED) ---
            function initAttendanceTable() { /* ... same logic ... */
                attendanceTbody.innerHTML = "";
                if (!STUDENTS || STUDENTS.length === 0) {
                     attendanceTbody.innerHTML = '<tr><td colspan="3">No student data loaded.</td></tr>';
                     return;
                }
                STUDENTS.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="Roll No">${student.roll_no}</td>
                        <td data-label="Name">${student.name}</td>
                        <td data-label="Status">
                            <span class="status-display" data-roll="${student.roll_no}">-</span>
                        </td>
                    `;
                    attendanceTbody.appendChild(row);
                });
                consoleLog("Attendance table structure initialized.");
            }

            function loadAttendance(date) { // MODIFIED: Uses subject filter
                consoleLog(`Displaying attendance for Subject Filter: ${currentSubjectFilter}, Date: ${date}`);

                if (!STUDENTS || STUDENTS.length === 0) {
                    showError("attendance-error", "Student list not loaded.", true);
                    return;
                }
                if (!date) { // If no date selected, clear table
                    attendanceTbody.querySelectorAll('.status-display').forEach(span => {
                        span.textContent = '-';
                        span.className = 'status-display status-unknown';
                    });
                    return;
                }

                showError("attendance-error", "", false);

                let dateData = [];
                let foundRecord = false;

                // *** NEW *** Logic based on subject filter
                if (currentSubjectFilter === 'all') {
                    // If 'all', we won't show specific status, just indicate if recorded or not.
                    // Or simply prompt user to select a subject. Let's prompt.
                    attendanceTbody.querySelectorAll('.status-display').forEach(span => {
                         span.textContent = "Select Subject";
                         span.className = "status-display status-select-subject";
                    });
                    showToast("Select a specific subject to view attendance status.", "info", 2500);
                    return; // Stop here for 'all' subjects filter
                } else {
                    // Get data for the specific subject and date
                    dateData = attendanceData?.[currentSubjectFilter]?.[date] || [];
                    foundRecord = attendanceData?.[currentSubjectFilter]?.[date] !== undefined; // Check if the date key exists for the subject
                }

                const attendanceMap = new Map(dateData.map(item => [item.roll_no, item.status]));

                STUDENTS.forEach(student => {
                    const statusSpan = attendanceTbody.querySelector(`.status-display[data-roll="${student.roll_no}"]`);
                    if (statusSpan) {
                        const status = attendanceMap.get(student.roll_no);
                        if (status === "present") {
                            statusSpan.textContent = "Present";
                            statusSpan.className = "status-display status-present";
                        } else if (status === "absent") {
                            statusSpan.textContent = "Absent";
                            statusSpan.className = "status-display status-absent";
                        } else {
                            // No record found for this student *in this subject* on this date
                            statusSpan.textContent = "No Record";
                            statusSpan.className = "status-display status-unknown";
                        }
                    }
                });

                if (currentSubjectFilter !== 'all') {
                     if (foundRecord) {
                        showToast(`Showing attendance for ${currentSubjectFilter} on ${date}`, "info", 1500);
                     } else {
                        showToast(`No attendance record found for ${currentSubjectFilter} on ${date}`, "info", 1500);
                     }
                 }
            }

             function updateDateHistory() { // MODIFIED: Find unique dates across all subjects
                dateHistoryElement.innerHTML = "";
                const allDates = new Set();
                Object.values(attendanceData).forEach(subjectData => {
                    Object.keys(subjectData).forEach(date => allDates.add(date));
                });

                const dates = Array.from(allDates).sort().reverse();
                dates.forEach(date => {
                    const chip = document.createElement('div');
                    chip.className = 'date-chip';
                    chip.textContent = date;
                    chip.dataset.date = date;
                    chip.addEventListener('click', () => loadAttendanceForDate(date)); // Still uses separate func
                    dateHistoryElement.appendChild(chip);
                });
                highlightActiveDateChip();
            }

            function highlightActiveDateChip() { /* ... same logic ... */
                 const currentDate = attendanceDateInput.value;
                 document.querySelectorAll(".date-chip").forEach(chip => {
                     chip.classList.toggle("active", chip.dataset.date === currentDate);
                 });
            }

            function loadAttendanceForDate(date) { // Renamed from admin's combined func
                consoleLog(`Date chip clicked: ${date}`);
                attendanceDateInput.value = date;
                highlightActiveDateChip();
                loadAttendance(date); // Reload attendance display using the current subject filter
            }


            // --- Metrics Page Functions (MODIFIED: Subject Filter Aware) ---
            function updateMetrics() {
                consoleLog(`Updating metrics for filter: ${currentSubjectFilter}`);
                 if (!STUDENTS || STUDENTS.length === 0) { /* ... handle no students ... */ return; }

                // *** NEW *** Determine which part of attendanceData to use
                let relevantAttendance = {};
                let subjectTitle = "All Subjects";
                if (currentSubjectFilter === 'all') {
                    relevantAttendance = attendanceData; // Use the whole structure
                } else if (attendanceData[currentSubjectFilter]) {
                    relevantAttendance = { [currentSubjectFilter]: attendanceData[currentSubjectFilter] }; // Use only selected subject's data
                    subjectTitle = currentSubjectFilter;
                } else {
                     // Subject selected but no data for it
                    relevantAttendance = {};
                    subjectTitle = currentSubjectFilter;
                }

                // *** NEW *** Update display spans for context
                metricsSubjectSpans.forEach(span => span.textContent = subjectTitle);
                metricsTitle.textContent = `Attendance Metrics - ${subjectTitle}`;


                // Calculate total classes *within the filtered scope*
                let totalClasses = 0;
                let allDatesSet = new Set();
                Object.values(relevantAttendance).forEach(subjectData => {
                     Object.keys(subjectData).forEach(date => allDatesSet.add(date));
                });
                totalClasses = allDatesSet.size;
                totalClassesElement.textContent = totalClasses.toString();

                if (totalClasses === 0) { /* ... handle no classes recorded ... */
                    avgAttendanceElement.textContent = "0%";
                    bestDayElement.textContent = "-";
                    worstDayElement.textContent = "-";
                    metricsTbody.innerHTML = '<tr><td colspan="5">No attendance data recorded for this selection.</td></tr>';
                    destroyChart("attendance_chart");
                    return;
                }


                let studentMetrics = {};
                STUDENTS.forEach(s => {
                    studentMetrics[s.roll_no] = { name: s.name, present: 0, absent: 0, total_marked_days: 0 };
                });

                let dailyRates = {}; // Key: date, Value: { present: count, total_students_on_day: count }
                const allDatesSorted = Array.from(allDatesSet).sort();

                // Iterate through the *relevant* subjects and dates
                Object.values(relevantAttendance).forEach(subjectData => {
                     allDatesSorted.forEach(date => {
                         const attendanceList = subjectData[date] || [];
                         if (attendanceList.length > 0) { // Only consider days with records for daily rate
                             if (!dailyRates[date]) dailyRates[date] = { present: 0, total_students_marked: 0 };

                             attendanceList.forEach(entry => {
                                 const rollNo = entry.roll_no;
                                 if (studentMetrics[rollNo]) { // Ensure student exists in current list
                                    // Increment overall metrics for the student
                                    studentMetrics[rollNo].total_marked_days++; // Count days this student was marked in filter scope
                                    if (entry.status === "present") {
                                        studentMetrics[rollNo].present++;
                                        dailyRates[date].present++;
                                    } else if (entry.status === "absent") {
                                        studentMetrics[rollNo].absent++;
                                    }
                                    dailyRates[date].total_students_marked++; // Total valid entries for the day's rate calc
                                 }
                             });
                         }
                    });
                });

                // Calculate daily percentages
                let dailyPercentages = {};
                let bestDayVal = -1, worstDayVal = 101, bestDayDate = "-", worstDayDate = "-";
                let totalPresentOverall = 0;

                Object.entries(dailyRates).forEach(([date, counts]) => {
                     // Base daily rate on students marked *that day* for that rate
                    const rate = counts.total_students_marked > 0 ? (counts.present / counts.total_students_marked) * 100 : 0;
                    dailyPercentages[date] = rate;
                    if (rate > bestDayVal) { bestDayVal = rate; bestDayDate = date; }
                    if (rate < worstDayVal) { worstDayVal = rate; worstDayDate = date; }
                });


                 // Calculate overall average based on *total classes in filter*
                let totalPossibleAttendances = STUDENTS.length * totalClasses;
                 Object.values(studentMetrics).forEach(m => totalPresentOverall += m.present);
                 const avgAttendanceOverall = totalPossibleAttendances > 0 ? (totalPresentOverall / totalPossibleAttendances) * 100 : 0;


                 // Update Overall Stats Display
                 avgAttendanceElement.textContent = `${avgAttendanceOverall.toFixed(1)}%`;
                 bestDayElement.textContent = bestDayVal >= 0 ? `${bestDayDate} (${bestDayVal.toFixed(1)}%)` : "-";
                 worstDayElement.textContent = worstDayVal <= 100 ? `${worstDayDate} (${worstDayVal.toFixed(1)}%)` : "-";


                // Update metrics table
                metricsTbody.innerHTML = "";
                Object.entries(studentMetrics).forEach(([rollNo, metrics]) => {
                    // Calculate percentage based on total classes held within the filter scope
                    const attendancePercent = totalClasses > 0 ? (metrics.present / totalClasses) * 100 : 0;
                    let percentClass = "poor"; /* ... set class based on percent ... */
                    if (attendancePercent >= 90) percentClass = "excellent";
                    else if (attendancePercent >= 75) percentClass = "good";
                    else if (attendancePercent >= 60) percentClass = "average";

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="Roll No">${rollNo}</td>
                        <td data-label="Name">${metrics.name}</td>
                        <td data-label="Present">${metrics.present}</td>
                        <td data-label="Absent">${totalClasses - metrics.present}</td>
                        <td data-label="Attend %" class="${percentClass}">${attendancePercent.toFixed(1)}%</td>
                    `;
                    metricsTbody.appendChild(row);
                });

                updateAttendanceChart(dailyPercentages); // Pass calculated daily %
                consoleLog("Metrics updated successfully.");
            }

            // --- Rankings Page Functions (MODIFIED: Subject Filter Aware) ---
            function updateRankings() {
                consoleLog(`Updating rankings for filter: ${currentSubjectFilter}`);
                if (!STUDENTS || STUDENTS.length === 0) { /* ... handle no students ... */ return; }

                // *** NEW *** Determine relevant data and update titles/spans
                let relevantAttendance = {};
                let subjectTitle = "All Subjects";
                if (currentSubjectFilter === 'all') {
                    relevantAttendance = attendanceData;
                } else if (attendanceData[currentSubjectFilter]) {
                    relevantAttendance = { [currentSubjectFilter]: attendanceData[currentSubjectFilter] };
                    subjectTitle = currentSubjectFilter;
                } else {
                    relevantAttendance = {};
                     subjectTitle = currentSubjectFilter;
                }
                rankingSubjectSpans.forEach(span => span.textContent = subjectTitle);
                 rankingTitle.textContent = `Student Rankings - ${subjectTitle}`;

                // Calculate total classes *within the filtered scope*
                 let totalClasses = 0;
                 let allDatesSet = new Set();
                 Object.values(relevantAttendance).forEach(subjectData => {
                      Object.keys(subjectData).forEach(date => allDatesSet.add(date));
                 });
                 totalClasses = allDatesSet.size;

                if (totalClasses === 0) { /* ... handle no classes recorded ... */
                    rankingTbody.innerHTML = '<tr><td colspan="4">No attendance data recorded for this selection.</td></tr>';
                    destroyChart("distribution_chart");
                    return;
                 }


                 let studentSummary = STUDENTS.map(student => {
                    const rollNo = student.roll_no;
                    let presentCount = 0;

                    // Count present days by iterating through *relevant* data
                    Object.values(relevantAttendance).forEach(subjectData => {
                        allDatesSet.forEach(date => { // Use the dates relevant to the filter
                             const attendanceList = subjectData[date] || [];
                             const entry = attendanceList.find(e => e.roll_no === rollNo);
                             if (entry && entry.status === "present") {
                                 presentCount++;
                             }
                        });
                    });

                    const attendancePercent = totalClasses > 0 ? (presentCount / totalClasses) * 100 : 0;
                    return { roll_no: rollNo, name: student.name, attendance_percent: attendancePercent };
                });

                // Sort (same logic)
                studentSummary.sort((a, b) => b.attendance_percent - a.attendance_percent || a.name.localeCompare(b.name));

                // Update ranking table (same logic)
                rankingTbody.innerHTML = "";
                let currentRank = 0, lastPercent = -1, studentsAtRank = 0;
                studentSummary.forEach((summary) => { /* ... same row generation ... */
                    const percent = summary.attendance_percent;
                     if (percent !== lastPercent) { currentRank += (studentsAtRank + 1); studentsAtRank = 0; lastPercent = percent; } else { studentsAtRank++; }
                     let rankClass = "poor";
                     if (percent >= 90) rankClass = "excellent"; else if (percent >= 75) rankClass = "good"; else if (percent >= 60) rankClass = "average";
                     const row = document.createElement('tr');
                     row.innerHTML = `
                         <td data-label="Rank">${currentRank}</td>
                         <td data-label="Roll No">${summary.roll_no}</td>
                         <td data-label="Name">${summary.name}</td>
                         <td data-label="Attend %" class="${rankClass}">${percent.toFixed(1)}%</td>
                     `;
                     rankingTbody.appendChild(row);
                });

                updateDistributionChart(studentSummary);
                consoleLog("Rankings updated successfully.");
            }

            // --- Chart Update Functions (Unchanged logic, data passed in) ---
            function destroyChart(chartId) { /* ... same ... */
                 if (attendanceCharts[chartId]) {
                     try { attendanceCharts[chartId].destroy(); attendanceCharts[chartId] = null; consoleLog(`Chart '${chartId}' destroyed.`); }
                     catch (e) { consoleLog(`Error destroying chart '${chartId}': ${e}`); }
                 }
             }
            function updateAttendanceChart(dailyPercentages) { /* ... same ... (uses dailyPercentages passed in) */
                 consoleLog("Updating attendance trend chart...");
                 const chartId = "attendance_chart"; const canvasId = "attendance-chart";
                 destroyChart(chartId);
                 if (!dailyPercentages || Object.keys(dailyPercentages).length === 0) { /* ... handle no data ... */ return; }
                 try {
                     const sortedDates = Object.keys(dailyPercentages).sort();
                     const attendanceRates = sortedDates.map(date => dailyPercentages[date]);
                     const canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext("2d");
                     attendanceCharts[chartId] = new Chart(ctx, {
                         type: "line",
                         data: { labels: sortedDates, datasets: [{ label: "Daily Attendance Rate (%)", data: attendanceRates, backgroundColor: "rgba(74, 144, 226, 0.15)", borderColor: "rgba(74, 144, 226, 1)", borderWidth: 2.5, tension: 0.3, fill: true, pointBackgroundColor: "rgba(74, 144, 226, 1)", pointRadius: 4, pointHoverRadius: 6 }] },
                         options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: "Attendance Rate (%)" } }, x: { title: { display: true, text: "Date" } } }, plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false, callbacks: { title: (items) => items[0]?.label ?? '', label: (context) => `Attendance: ${context.parsed.y.toFixed(1)}%` } } }, interaction: { mode: 'index', intersect: false } }
                     });
                     consoleLog("Attendance chart updated.");
                 } catch (e) { consoleLog(`Error updating attendance chart: ${e}`); showToast("Could not display attendance trend chart", "error"); }
             }
             function updateDistributionChart(studentSummary) { /* ... same ... (uses studentSummary passed in) */
                 consoleLog("Updating attendance distribution chart...");
                 const chartId = "distribution_chart"; const canvasId = "distribution-chart";
                 destroyChart(chartId);
                 if (!studentSummary || studentSummary.length === 0) { /* ... handle no data ... */ return; }
                 try {
                     const ranges = { "Excellent (>=90%)": 0, "Good (75-89%)": 0, "Average (60-74%)": 0, "Poor (<60%)": 0 };
                     studentSummary.forEach(summary => { /* ... count ranges ... */
                         const percent = summary.attendance_percent;
                         if (percent >= 90) ranges["Excellent (>=90%)"]++; else if (percent >= 75) ranges["Good (75-89%)"]++; else if (percent >= 60) ranges["Average (60-74%)"]++; else ranges["Poor (<60%)"]++;
                     });
                     const canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext("2d");
                     const computedStyle = getComputedStyle(document.documentElement);
                     const colors = [ computedStyle.getPropertyValue('--green-color').trim() || '#06d6a0', computedStyle.getPropertyValue('--secondary-color').trim() || '#27ae60', computedStyle.getPropertyValue('--yellow-color').trim() || '#f1c40f', computedStyle.getPropertyValue('--red-color').trim() || '#c0392b' ];
                     attendanceCharts[chartId] = new Chart(ctx, {
                         type: "pie",
                         data: { labels: Object.keys(ranges), datasets: [{ label: "Number of Students", data: Object.values(ranges), backgroundColor: colors, borderColor: "rgba(255, 255, 255, 0.7)", borderWidth: 1.5 }] },
                         options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, boxWidth: 15, usePointStyle: true } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} students`, afterLabel: (c) => { const total = c.dataset.data.reduce((s, v) => s + v, 0); return total > 0 ? `${((c.raw / total) * 100).toFixed(1)}% of total` : ""; } } }, title: { display: false } } }
                     });
                     consoleLog("Distribution chart updated.");
                 } catch (e) { consoleLog(`Error updating distribution chart: ${e}`); showToast("Could not display distribution chart", "error"); }
             }


            // --- Navigation (MODIFIED to trigger updates) ---
            function switchPage(targetPageId) {
                 if (targetPageId === currentPage) return;
                 consoleLog(`Switching page from ${currentPage} to ${targetPageId}`);
                 Object.values(pageIds).forEach(pageDomId => { /* ... toggle active ... */
                    document.getElementById(pageDomId)?.classList.toggle("active", pageDomId === pageIds[targetPageId]);
                 });
                 navItems.forEach(item => { /* ... toggle active ... */
                     item.classList.toggle("active", item.dataset.page === targetPageId);
                 });
                 currentPage = targetPageId;
                 updateHighlight();

                 // *** Trigger updates based on the new page and current filters ***
                 if (targetPageId === "metrics") {
                    updateMetrics();
                 } else if (targetPageId === "ranking") {
                    updateRankings();
                 } else if (targetPageId === "attendance") {
                    updateDateHistory(); // Refresh history
                    loadAttendance(attendanceDateInput.value); // Reload attendance view
                 }
            }
            function onNavClick(event) { /* ... same ... */
                 const targetPage = event.currentTarget.dataset.page;
                 if (targetPage) switchPage(targetPage);
             }
            function updateHighlight() { /* ... same ... */
                 const activeNav = document.querySelector(".nav-item.active");
                 if (activeNav && highlightElement) { /* ... set style ... */
                    highlightElement.style.left = `${activeNav.offsetLeft}px`;
                    highlightElement.style.width = `${activeNav.offsetWidth}px`;
                 } else if (highlightElement) { highlightElement.style.width = `0px`; }
             }

            // --- Event Handlers ---
            function onDateChange(event) {
                const date = event.target.value;
                consoleLog(`Date changed to: ${date}`);
                loadAttendance(date); // Reload attendance view
                highlightActiveDateChip();
            }

            // *** NEW *** Handle subject filter change
            function onSubjectFilterChange(event) {
                 currentSubjectFilter = event.target.value;
                 consoleLog(`Subject filter changed to: ${currentSubjectFilter}`);
                 // Reload data display for current page
                 if (currentPage === 'attendance') {
                     loadAttendance(attendanceDateInput.value);
                 } else if (currentPage === 'metrics') {
                     updateMetrics();
                 } else if (currentPage === 'ranking') {
                     updateRankings();
                 }
            }

            // --- Initialization ---
            function initEventListeners() {
                navItems.forEach(item => item.addEventListener('click', onNavClick));
                attendanceDateInput.addEventListener('change', onDateChange);
                subjectFilterSelect.addEventListener('change', onSubjectFilterChange); // *** NEW ***
                window.addEventListener('resize', updateHighlight);
                consoleLog("Event listeners initialized.");
            }

             async function initApp() {
                consoleLog("Initializing Frontend Attendance View...");
                showLoading(true);
                initEventListeners();

                try {
                    const dataLoaded = await fetchData(); // Fetches students and nested attendance
                    if (dataLoaded) {
                        populateSubjectFilter(); // *** NEW *** Populate filter based on fetched data
                        initAttendanceTable(); // Needs STUDENTS
                        updateDateHistory(); // Needs attendanceData keys (across subjects)

                        const today = getTodayDate();
                        attendanceDateInput.value = today;
                        attendanceDateInput.max = today;
                        consoleLog(`Set date to today: ${today}`);
                        loadAttendance(today); // Initial load (will show "Select Subject" if filter is 'all')

                        setTimeout(updateHighlight, 150);
                        showToast("Attendance system ready", "success", 2000);
                    } else {
                         attendanceDateInput.disabled = true;
                         subjectFilterSelect.disabled = true; // Disable filter too
                         showError("attendance-error", "Application could not load data.", true);
                    }
                } catch (e) {
                     console.error(`Critical Error during app initialization: ${e}`);
                     showToast("Error initializing application!", "error", 5000);
                     if (contentElement) { contentElement.innerHTML = `<h1>Init Error</h1><p>${e.message}</p>`; }
                } finally {
                    showLoading(false);
                }
            }

            // --- Start the application ---
            initApp();

        }); // End DOMContentLoaded
    </script>
</body>
</html>
